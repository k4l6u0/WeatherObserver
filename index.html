<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯’æµé è­¦åˆ†æå·¥å…· (16å¤©ç‰ˆ)</title>
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ Chart.js æ•¸æ“šæ¨™ç±¤æ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #7f8c8d; font-size: 0.95rem; margin-bottom: 25px; }
        
        /* æ§åˆ¶é¢æ¿æ¨£å¼ */
        .controls { display: flex; flex-wrap: wrap; gap: 20px; background: #eef2f3; padding: 20px; border-radius: 10px; margin-bottom: 20px; align-items: flex-end; justify-content: center; }
        .control-group { display: flex; flex-direction: column; }
        label { font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #34495e; }
        input { padding: 10px; border: 1px solid #bdc3c7; border-radius: 6px; width: 80px; font-size: 16px; text-align: center; }
        button { padding: 10px 25px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; height: 42px; transition: background 0.2s; }
        button:hover { background-color: #2980b9; }

        /* ç‹€æ…‹èˆ‡æ—¥èªŒå€ */
        #result-area { margin-top: 20px; }
        .alert-box { padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none; line-height: 1.6; }
        .alert-danger { background-color: #fadbd8; color: #c0392b; border: 1px solid #f5b7b1; }
        .alert-success { background-color: #d4efdf; color: #1e8449; border: 1px solid #a9dfbf; }
        .log-item { background: #fff; border-left: 4px solid #e74c3c; padding: 15px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* åœ–è¡¨å€ */
        .chart-container { position: relative; height: 500px; width: 100%; margin-top: 40px; }
        .loading { text-align: center; display: none; color: #7f8c8d; font-weight: bold; margin: 20px 0; }
        
        /* è¼‰å…¥å‹•ç•«å°åœˆåœˆ */
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: #3498db; animation: spin 1s ease-in-out infinite; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>â„ï¸ å¯’æµè·¯å¾‘é è­¦å„€è¡¨æ¿</h1>
    <div class="subtitle">é æ¸¬ç¯„åœï¼šæœªä¾† 16 å¤© | è³‡æ–™ä¾†æºï¼šOpen-Meteo | ç›£æ¸¬è·¯å¾‘ï¼šé›…åº«æ¬¡å…‹ â” åŒ—äº¬ â” ä¸Šæµ· â” å°åŒ—</div>

    <!-- è¨­å®šå€ -->
    <div class="controls">
        <div class="control-group">
            <label>æ°£æº«é©Ÿé™é–€æª» (Â°C)</label>
            <input type="number" id="dropThreshold" value="5" min="1">
        </div>
        <div class="control-group">
            <label>å‚³å°å»¶é² (æœ€å°‘å¤©)</label>
            <input type="number" id="lagMin" value="1" min="0">
        </div>
        <div class="control-group">
            <label>å‚³å°å»¶é² (æœ€å¤šå¤©)</label>
            <input type="number" id="lagMax" value="3" min="1">
        </div>
        <button onclick="analyzeWeather()">ğŸš€ é–‹å§‹åˆ†æ</button>
    </div>

    <div id="loading" class="loading"><span class="spinner"></span>æ­£åœ¨é€£ç·šæ°£è±¡è¡›æ˜ŸæŠ“å– 16 å¤©è³‡æ–™...</div>

    <!-- çµæœé¡¯ç¤ºå€ -->
    <div id="result-area">
        <div id="statusBox" class="alert-box"></div>
        <div id="logContent"></div>
    </div>

    <!-- åœ–è¡¨å€ -->
    <div class="chart-container">
        <canvas id="weatherChart"></canvas>
    </div>
</div>

<script>
    // è¨»å†Šæ•¸æ“šæ¨™ç±¤æ’ä»¶
    Chart.register(ChartDataLabels);

    // åŸå¸‚åº§æ¨™èˆ‡é¡è‰²å®šç¾©
    const cities = [
        { id: 'A', name: 'é›…åº«æ¬¡å…‹ (A)', lat: 62.03, lon: 129.74, color: '#2980b9', bg: '#d4e6f1' }, // è—
        { id: 'B', name: 'åŒ—äº¬ (B)', lat: 39.90, lon: 116.40, color: '#e67e22', bg: '#fadbd8' },     // æ©˜
        { id: 'C', name: 'ä¸Šæµ· (C)', lat: 31.23, lon: 121.47, color: '#27ae60', bg: '#d5f5e3' },    // ç¶ 
        { id: 'D', name: 'å°åŒ— (D)', lat: 25.03, lon: 121.56, color: '#c0392b', bg: '#fdedec' }     // ç´…
    ];

    let myChart = null;

    async function analyzeWeather() {
        const threshold = parseFloat(document.getElementById('dropThreshold').value);
        const lagMin = parseInt(document.getElementById('lagMin').value);
        const lagMax = parseInt(document.getElementById('lagMax').value);
        
        // UI é‡ç½®
        document.getElementById('loading').style.display = 'block';
        document.getElementById('statusBox').style.display = 'none';
        document.getElementById('logContent').innerHTML = '';
        
        try {
            // æŠ“å– 16 å¤©è³‡æ–™ (forecast_days=16)
            const promises = cities.map(city => {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&daily=temperature_2m_min&timezone=auto&forecast_days=16`;
                return fetch(url).then(res => res.json());
            });

            const results = await Promise.all(promises);
            document.getElementById('loading').style.display = 'none';

            // æ•´ç†æ•¸æ“š
            const weatherData = {};
            const dates = results[0].daily.time.map(date => date.substring(5)); // åªç•™ MM-DD

            results.forEach((data, index) => {
                const cityId = cities[index].id;
                weatherData[cityId] = data.daily.temperature_2m_min;
            });

            // ç¹ªè£½åœ–è¡¨
            drawChart(dates, weatherData);

            // æ ¸å¿ƒé‚è¼¯ï¼šåˆ¤æ–·é€£é–åæ‡‰
            let alerts = [];
            const dataA = weatherData['A'];
            const dataB = weatherData['B'];
            const dataC = weatherData['C'];
            
            // è¨ˆç®—æƒæç¯„åœ (è³‡æ–™ç¸½é•·åº¦ - æœ€å¤§å»¶é²æ‰€éœ€å¤©æ•¸ - 1å¤©è¨ˆç®—é™æº«)
            const maxScanDay = dataA.length - (lagMax * 2) - 1;

            for (let i = 0; i < maxScanDay; i++) {
                let dropA = dataA[i] - dataA[i+1];

                if (dropA >= threshold) {
                    for (let d1 = lagMin; d1 <= lagMax; d1++) {
                        let idxB = i + d1;
                        // é‚Šç•Œæª¢æŸ¥
                        if (idxB >= dataB.length - 1) continue;
                        
                        let dropB = dataB[idxB] - dataB[idxB+1];

                        if (dropB >= threshold) {
                            for (let d2 = lagMin; d2 <= lagMax; d2++) {
                                let idxC = idxB + d2;
                                // é‚Šç•Œæª¢æŸ¥
                                if (idxC >= dataC.length - 1) continue;

                                let dropC = dataC[idxC] - dataC[idxC+1];

                                if (dropC >= threshold) {
                                    alerts.push({
                                        msg: `
                                            <div style="font-size:1.1em; font-weight:bold; margin-bottom:5px;">ğŸ¥¶ å¯’æµè·¯å¾‘ç¢ºèª (è§¸ç™¼é»: ${dates[i]})</div>
                                            1. <span style="color:${cities[0].color}">A-é›…åº«æ¬¡å…‹</span>: ${dates[i]} é©Ÿé™ <b>${dropA.toFixed(1)}Â°C</b><br>
                                            2. <span style="color:${cities[1].color}">B-åŒ—äº¬</span> (${d1}å¤©å¾Œ): ${dates[idxB]} é©Ÿé™ <b>${dropB.toFixed(1)}Â°C</b><br>
                                            3. <span style="color:${cities[2].color}">C-ä¸Šæµ·</span> (${d2}å¤©å¾Œ): ${dates[idxC]} é©Ÿé™ <b>${dropC.toFixed(1)}Â°C</b><br>
                                            ğŸ‘‰ <b>å°åŒ— (D) éœ€åœ¨ ${dates[idxC]} ä¹‹å¾Œåš´åŠ æˆ’å‚™ï¼</b>
                                        `
                                    });
                                }
                            }
                        }
                    }
                }
            }

            // é¡¯ç¤ºçµæœ
            const statusBox = document.getElementById('statusBox');
            const logContent = document.getElementById('logContent');
            
            if (alerts.length > 0) {
                statusBox.className = 'alert-box alert-danger';
                statusBox.innerHTML = `âš ï¸ <b>è­¦å ±ç™¼å¸ƒï¼</b> åµæ¸¬åˆ° <b>${alerts.length}</b> æ¢æ¥µåœ°å†·ç©ºæ°£å—ä¸‹è·¯å¾‘ã€‚`;
                statusBox.style.display = 'block';
                
                alerts.forEach(alert => {
                    const div = document.createElement('div');
                    div.className = 'log-item';
                    div.innerHTML = alert.msg;
                    logContent.appendChild(div);
                });
            } else {
                statusBox.className = 'alert-box alert-success';
                statusBox.innerHTML = `âœ… <b>ç›®å‰å®‰å…¨</b>ï¼šæœªä¾† 16 å¤©å…§ï¼Œæœªåµæ¸¬åˆ°ç¬¦åˆã€Œå–®æ—¥é™æº« > ${threshold}Â°Cã€ä¸”å…·å‚™é€£é–åæ‡‰çš„å¯’æµè·¯å¾‘ã€‚`;
                statusBox.style.display = 'block';
            }

        } catch (error) {
            console.error(error);
            alert("è³‡æ–™æŠ“å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ç¶²è·¯ã€‚");
            document.getElementById('loading').style.display = 'none';
        }
    }

    function drawChart(labels, dataMap) {
        const ctx = document.getElementById('weatherChart').getContext('2d');
        
        if (myChart) {
            myChart.destroy();
        }

        const datasets = cities.map(city => ({
            label: city.name,
            data: dataMap[city.id],
            borderColor: city.color,
            backgroundColor: city.color,
            borderWidth: 2,
            tension: 0.3, // ç·šæ¢å¹³æ»‘åº¦
            pointRadius: 4,
            fill: false,
            datalabels: {
                align: 'top',
                anchor: 'center',
                offset: 4,
                color: city.color,
                font: {
                    weight: 'bold',
                    size: 11
                },
                formatter: function(value) {
                    return Math.round(value); // é¡¯ç¤ºæ•´æ•¸ï¼Œé¿å…å¤ªæ“æ“ 
                }
            }
        }));

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 20, right: 20, left: 10, bottom: 10 }
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        title: { display: true, text: 'æœ€ä½æ°£æº« (Â°C)' },
                        grid: { color: '#f0f0f0' }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    title: { display: true, text: 'æœªä¾† 16 å¤©å››åŸå¸‚æ°£æº«è¶¨å‹¢åœ–', font: { size: 16 } },
                    legend: { position: 'bottom' },
                    tooltip: {
                        enabled: true, // ä¿ç•™æ»‘é¼ æ‡¸åœæç¤º
                        backgroundColor: 'rgba(0,0,0,0.7)',
                    }
                }
            }
        });
    }
</script>

</body>

</html>
