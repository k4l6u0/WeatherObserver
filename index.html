<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯’æµåˆ†å±¤é è­¦å„€è¡¨æ¿ (å¤§åœ–ç¤ºç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #2c3e50; margin: 0 0 5px 0; }
        .subtitle { text-align: center; color: #7f8c8d; font-size: 0.9rem; margin-bottom: 20px; }
        
        /* æ§åˆ¶å€ */
        .controls { display: flex; flex-wrap: wrap; gap: 15px; background: #eceff1; padding: 15px; border-radius: 8px; margin-bottom: 20px; align-items: flex-end; justify-content: center; }
        .control-group { display: flex; flex-direction: column; }
        label { font-size: 13px; font-weight: 600; margin-bottom: 4px; color: #455a64; }
        input { padding: 8px; border: 1px solid #cfd8dc; border-radius: 4px; width: 70px; text-align: center; }
        button { padding: 8px 20px; background-color: #37474f; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; height: 36px; }
        button:hover { background-color: #263238; }

        /* è­¦å ±å€ */
        #result-area { margin-bottom: 20px; }
        .alert-box { padding: 15px; border-radius: 6px; margin-bottom: 10px; display: none; font-size: 0.95rem; }
        .alert-danger { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .alert-success { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        
        /* åœ–è¡¨å€ - é«˜åº¦ç¶­æŒ 800px ä»¥å®¹ç´åˆ†å±¤å’Œå¤§å­—é«” */
        .chart-container { position: relative; height: 800px; width: 100%; } 
        
        .loading { text-align: center; display: none; color: #78909c; font-weight: bold; margin: 20px 0; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: #37474f; animation: spin 1s infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“‰ å¯’æµåˆ†å±¤ç›£æ¸¬å„€è¡¨æ¿</h1>
    <div class="subtitle">é›…åº«æ¬¡å…‹ â” åŒ—äº¬ â” ä¸Šæµ· â” å°åŒ— (å¤©æ°£åœ–ç¤ºå·²æ”¾å¤§)</div>

    <div class="controls">
        <div class="control-group">
            <label>é™æº«é–€æª» (Â°C)</label>
            <input type="number" id="dropThreshold" value="5" min="1">
        </div>
        <div class="control-group">
            <label>å»¶é² (æœ€å°‘å¤©)</label>
            <input type="number" id="lagMin" value="1" min="0">
        </div>
        <div class="control-group">
            <label>å»¶é² (æœ€å¤šå¤©)</label>
            <input type="number" id="lagMax" value="3" min="1">
        </div>
        <button onclick="analyzeWeather()">æ›´æ–°åˆ†æ</button>
    </div>

    <div id="loading" class="loading"><span class="spinner"></span>æ­£åœ¨é€£ç·š Open-Meteo æ°£è±¡è¡›æ˜Ÿ...</div>

    <div id="result-area">
        <div id="statusBox" class="alert-box"></div>
        <div id="logContent"></div>
    </div>

    <div class="chart-container">
        <canvas id="weatherChart"></canvas>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);

    const cities = [
        // axis å°æ‡‰ yAxisID
        { id: 'A', name: 'é›…åº«æ¬¡å…‹ (æºé ­)', lat: 62.03, lon: 129.74, color: '#1976D2', axis: 'yA' },
        { id: 'B', name: 'åŒ—äº¬ (ä¸­ç¹¼)', lat: 39.90, lon: 116.40, color: '#F57C00', axis: 'yB' },
        { id: 'C', name: 'ä¸Šæµ· (ä¸­ç¹¼)', lat: 31.23, lon: 121.47, color: '#388E3C', axis: 'yC' },
        { id: 'D', name: 'å°åŒ— (ç›®æ¨™)', lat: 25.03, lon: 121.56, color: '#D32F2F', axis: 'yD' }
    ];

    let myChart = null;

    function getWeatherEmoji(code) {
        if (code === 0) return 'â˜€ï¸'; 
        if (code <= 3) return 'â˜ï¸'; 
        if (code <= 48) return 'ğŸŒ«ï¸'; 
        if (code <= 67) return 'ğŸŒ§ï¸'; 
        if (code <= 77) return 'â„ï¸'; 
        if (code <= 82) return 'ğŸŒ§ï¸'; 
        if (code <= 86) return 'ğŸŒ¨ï¸'; 
        if (code <= 99) return 'â›ˆï¸'; 
        return '';
    }

    async function analyzeWeather() {
        const threshold = parseFloat(document.getElementById('dropThreshold').value);
        const lagMin = parseInt(document.getElementById('lagMin').value);
        const lagMax = parseInt(document.getElementById('lagMax').value);
        
        document.getElementById('loading').style.display = 'block';
        document.getElementById('statusBox').style.display = 'none';
        document.getElementById('logContent').innerHTML = '';
        
        try {
            const promises = cities.map(city => {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&daily=temperature_2m_min,weathercode&timezone=auto&forecast_days=16`;
                return fetch(url).then(res => res.json());
            });

            const results = await Promise.all(promises);
            document.getElementById('loading').style.display = 'none';

            const weatherData = {};
            const weatherCodes = {};
            const dates = results[0].daily.time.map(date => date.substring(5)); // MM-DD

            results.forEach((data, index) => {
                const cityId = cities[index].id;
                weatherData[cityId] = data.daily.temperature_2m_min;
                weatherCodes[cityId] = data.daily.weathercode;
            });

            drawChart(dates, weatherData, weatherCodes);

            // --- é‚è¼¯åˆ¤æ–· ---
            let alerts = [];
            const dataA = weatherData['A'];
            const dataB = weatherData['B'];
            const dataC = weatherData['C'];
            const maxScanDay = dataA.length - (lagMax * 2) - 1;

            for (let i = 0; i < maxScanDay; i++) {
                let dropA = dataA[i] - dataA[i+1];
                if (dropA >= threshold) {
                    for (let d1 = lagMin; d1 <= lagMax; d1++) {
                        let idxB = i + d1;
                        if (idxB >= dataB.length) continue;
                        let dropB = dataB[idxB] - dataB[idxB+1];
                        if (dropB >= threshold) {
                            for (let d2 = lagMin; d2 <= lagMax; d2++) {
                                let idxC = idxB + d2;
                                if (idxC >= dataC.length) continue;
                                let dropC = dataC[idxC] - dataC[idxC+1];
                                if (dropC >= threshold) {
                                    alerts.push({ msg: `ğŸ¥¶ è·¯å¾‘ç¢ºèª: A(${dates[i]}) â” B(${dates[idxB]}) â” C(${dates[idxC]})` });
                                }
                            }
                        }
                    }
                }
            }

            const statusBox = document.getElementById('statusBox');
            if (alerts.length > 0) {
                statusBox.className = 'alert-box alert-danger';
                statusBox.innerHTML = `âš ï¸ <b>è­¦å ±ï¼</b> åµæ¸¬åˆ° ${alerts.length} æ¢ç¬¦åˆæ¢ä»¶çš„å¯’æµè·¯å¾‘ã€‚`;
                statusBox.style.display = 'block';
                alerts.forEach(a => {
                    const d = document.createElement('div');
                    d.innerHTML = a.msg;
                    document.getElementById('logContent').appendChild(d);
                });
            } else {
                statusBox.className = 'alert-box alert-success';
                statusBox.innerHTML = `âœ… æœªä¾† 16 å¤©å…§æœªåµæ¸¬åˆ°ç¬¦åˆè¨­å®šæ¢ä»¶çš„é€£é–å¯’æµã€‚`;
                statusBox.style.display = 'block';
            }

        } catch (error) {
            console.error(error);
            document.getElementById('loading').style.display = 'none';
        }
    }

    function drawChart(labels, tempMap, codeMap) {
        const ctx = document.getElementById('weatherChart').getContext('2d');
        if (myChart) myChart.destroy();

        const datasets = cities.map((city) => ({
            label: city.name,
            data: tempMap[city.id],
            borderColor: city.color,
            backgroundColor: city.color,
            borderWidth: 2,
            pointRadius: 4,
            yAxisID: city.axis,
            datalabels: {
                align: 'top',
                anchor: 'center',
                offset: 4,
                color: '#333',
                // é€™è£¡è¨­å®šå­—é«”å¤§å°ï¼š15px (åŸ11px)
                font: { size: 15, weight: 'bold', family: 'Segoe UI Emoji' }, 
                formatter: (value, ctx) => {
                    const code = codeMap[city.id][ctx.dataIndex];
                    // ä½¿ç”¨ \n æ›è¡Œï¼Œè®“åœ–ç¤ºåœ¨æ•¸å­—ä¸‹æ–¹
                    return Math.round(value) + 'Â°\n' + getWeatherEmoji(code);
                },
                textAlign: 'center' // è®“æ›è¡Œå¾Œçš„æ–‡å­—ç½®ä¸­å°é½Š
            }
        }));

        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    // å¢åŠ ä¸Šæ–¹ Paddingï¼Œé¿å…ç¬¬ä¸€å±¤çš„å¤§åœ–ç¤ºè¢«åˆ‡æ‰
                    padding: { top: 30, bottom: 10 } 
                },
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { grid: { drawOnChartArea: false } }, 
                    
                    // --- 4å€‹å †ç–Š Y è»¸ ---
                    yA: {
                        type: 'linear', position: 'left',
                        stack: 'weatherStack', stackWeight: 1, 
                        title: { display: true, text: 'A-é›…åº«æ¬¡å…‹', color: '#1976D2' },
                        grid: { color: '#eee' }
                    },
                    yB: {
                        type: 'linear', position: 'left',
                        stack: 'weatherStack', stackWeight: 1, 
                        title: { display: true, text: 'B-åŒ—äº¬', color: '#F57C00' },
                        grid: { color: '#eee' },
                        offset: true
                    },
                    yC: {
                        type: 'linear', position: 'left',
                        stack: 'weatherStack', stackWeight: 1,
                        title: { display: true, text: 'C-ä¸Šæµ·', color: '#388E3C' },
                        grid: { color: '#eee' },
                        offset: true
                    },
                    yD: {
                        type: 'linear', position: 'left',
                        stack: 'weatherStack', stackWeight: 1,
                        title: { display: true, text: 'D-å°åŒ—', color: '#D32F2F' },
                        grid: { color: '#eee' },
                        offset: true
                    }
                },
                plugins: {
                    legend: { display: false }, 
                    tooltip: { enabled: true }
                }
            }
        });
    }
</script>

</body>
</html>