<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒè®Šå†·å˜¸ï¼Ÿ BUILD 251215ad</title>
    <!-- ä½¿ç”¨ç©©å®šçš„ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <style>
        /* Dark Mode å…¨å±€è¨­å®š */
        body { 
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; 
            background-color: #121212; 
            color: #e0e0e0; 
            margin: 0; padding: 20px; 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: #1e1e1e; 
            padding: 0; 
            border-radius: 16px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            overflow: hidden; 
            border: 1px solid #333;
        }
        
        /* æ¨™é¡Œå€ */
        header { 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); 
            padding: 25px 35px; 
            color: white; 
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }
        
        header::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(rgba(255,255,255,0.2) 15%, transparent 16%),
                radial-gradient(rgba(255,255,255,0.2) 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            opacity: 0.2;
            animation: snow 10s linear infinite;
        }
        @keyframes snow { from {background-position: 0 0, 30px 30px;} to {background-position: 0 60px, 30px 90px;} }

        /* å·¦å´æ¨™é¡Œå€ */
        .header-left { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: flex-start; }
        
        /* ä¸»æ¨™é¡Œæ¨£å¼ */
        h1 { 
            margin: 0; 
            font-size: 2.5rem; 
            font-weight: 900; 
            letter-spacing: 2px; 
            color: #4fc3f7; 
            text-shadow: 0 0 15px rgba(79, 195, 247, 0.4);
            line-height: 1.1;
        }
        
        /* ç‰ˆè™Ÿ */
        .build-tag-block { 
            font-family: 'Consolas', monospace;
            font-size: 0.8rem; 
            color: #1e1e1e; 
            background: #ffeb3b; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-weight: bold;
            margin-top: 8px;
            display: inline-block;
            letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(255, 235, 59, 0.3);
        }
        
        /* æŒ‡æ¨™èªªæ˜ */
        .hud-display {
            display: flex; gap: 15px; margin-top: 15px; font-size: 0.85rem; font-weight: 600; color: #ccc;
        }
        .hud-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 5px currentColor; }

        /* å³å´æŒ‰éˆ•å€ */
        .header-right { position: relative; z-index: 2; }
        .reload-btn {
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.5);
            color: #4fc3f7;
            padding: 10px 25px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.1);
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .reload-btn:hover {
            background: rgba(79, 195, 247, 0.2);
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.4);
            transform: translateY(-2px);
        }

        /* å…§å®¹å€ */
        .content-body { padding: 10px 25px 25px 25px; }

        /* åœ–è¡¨å€ */
        .chart-container { position: relative; height: 850px; width: 100%; margin-top: 20px; }
        .loading { text-align: center; display: none; color: #4fc3f7; font-weight: bold; margin: 50px 0; font-size: 1.2rem; letter-spacing: 2px; }

        /* Footer */
        footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #333; color: #777; font-size: 0.8rem; font-family: Consolas, monospace; }
        footer h3 { font-size: 0.9rem; margin-bottom: 10px; color: #aaa; text-transform: uppercase; }
        .version-tag { background: #333; padding: 2px 6px; border-radius: 3px; font-weight: bold; color: #eee; margin-right: 5px; border: 1px solid #555; }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 20px; text-align: center; align-items: center; }
            .header-left { align-items: center; }
            .hud-display { justify-content: center; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <h1>æœƒè®Šå†·å˜¸ï¼Ÿ</h1>
            <span class="build-tag-block">BUILD 251215ad</span>
            
            <div class="hud-display">
                <div class="hud-item"><span class="dot" style="background:#B388FF"></span> è¥¿è·¯</div>
                <div class="hud-item"><span class="dot" style="background:#448AFF"></span> æ±è·¯</div>
                <div class="hud-item"><span class="dot" style="background:#FF4081"></span> AI æ¨æ¼”</div>
            </div>
        </div>
        <div class="header-right">
            <button class="reload-btn" onclick="analyzeWeather()">
                <span>âš¡</span> RELOAD
            </button>
        </div>
    </header>

    <div class="content-body">
        
        <div style="display:none;">
            <input type="number" id="windowDays" value="2">
            <input type="number" id="dropThreshold" value="3">
            <input type="number" id="lagMin" value="0"> 
            <input type="number" id="lagMax" value="3">
        </div>

        <div id="loading" class="loading">ğŸ›°ï¸ ANCHORING TO CURRENT DATA...</div>

        <div class="chart-container">
            <canvas id="weatherChart"></canvas>
        </div>

        <footer>
            <h3>System Logs</h3>
            <ul>
                <li><span class="version-tag">251215ad</span> <b>ä»Šæ—¥éŒ¨å®š + ç‰©ç†è£œå„Ÿæ¨¡å‹ (Anchored Physics Model)</b>ï¼š
                    <br>1. <b>é›¶é»æ ¡æ­£</b>ï¼šæ¼”ç®—æ³•ç›´æ¥é–å®šã€Œä»Šæ—¥ã€å°åŒ—èˆ‡æºé ­çš„çœŸå¯¦æº«å·® (`GAP = TPE[0] - Source[0]`)ï¼Œæ¶ˆé™¤èµ·å§‹èª¤å·®ã€‚
                    <br>2. <b>å†·å¸ç†±è£œå„Ÿ</b>ï¼šæ ¹æ“šç†±åŠ›å­¸ç‰¹æ€§ï¼Œç•¶æºé ­æ°£æº«ä½æ–¼ 10Â°C æ™‚ï¼Œè‡ªå‹•å¢åŠ æµ·æ´‹åŠ ç†±è£œå„Ÿä¿‚æ•¸ (`(10-Source)*0.2`)ã€‚é€™ç¢ºä¿äº†å³ä½¿æºé ­ä½æº«ï¼Œæ¨æ¼”ç·šä¹Ÿæœƒå› ç‚ºåˆç†çš„è®Šæ€§å¢æº«è€Œè²¼è¿‘çœŸå¯¦é å ±ï¼Œä¸å†ç„¡æ•…å´©è·Œã€‚
                </li>
                <li><span class="version-tag">251215ac</span> ä¿®æ­£ç›¸å°è¶¨å‹¢å‚³å°çš„æ¼‚ç§»å•é¡Œã€‚</li>
            </ul>
        </footer>
    </div>
</div>

<script>
    if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
    }

    const locations = {
        ham: { name: 'å“ˆå¯† (è¥¿)', lat: 42.82, lon: 93.51, color: '#B388FF' },
        xia: { name: 'è¥¿å®‰ (è¥¿)', lat: 34.34, lon: 108.94, color: '#FFB74D' },
        wuh: { name: 'æ­¦æ¼¢ (è¥¿)', lat: 30.59, lon: 114.30, color: '#69F0AE' },
        
        yak: { name: 'é›…åº«æ¬¡å…‹ (æ±)', lat: 62.03, lon: 129.74, color: '#448AFF' },
        bei: { name: 'åŒ—äº¬ (æ±)', lat: 39.90, lon: 116.40, color: '#4DD0E1' },
        sha: { name: 'ä¸Šæµ· (æ±)', lat: 31.23, lon: 121.47, color: '#80DEEA' },

        tpe: { name: 'å°åŒ— (é å ±)', lat: 25.03, lon: 121.56, color: '#FF5252' }
    };

    let myChart = null;

    const weekendPlugin = {
        id: 'weekendPlugin',
        beforeDraw: (chart) => {
            const { ctx, chartArea: { top, bottom, height }, scales: { x } } = chart;
            ctx.save();
            x.ticks.forEach((tick, index) => {
                const dateStr = chart.data.rawDates[index];
                if (!dateStr) return;
                const dayOfWeek = new Date(dateStr).getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    const width = x.width / x.ticks.length;
                    const xPos = x.getPixelForTick(index) - (width / 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.05)'; 
                    ctx.fillRect(xPos, top, width, height);
                    ctx.fillStyle = '#888';
                    ctx.font = 'bold 10px "Segoe UI"';
                    ctx.textAlign = 'center';
                    ctx.fillText(dayOfWeek === 6 ? "SAT" : "SUN", x.getPixelForTick(index), top + 15);
                }
            });
            ctx.restore();
        }
    };

    function getWeatherEmoji(code) {
        if (code === undefined || code === null) return ''; 
        if (code === 0) return 'â˜€ï¸'; 
        if (code <= 3) return 'â˜ï¸'; 
        if (code <= 48) return 'ğŸŒ«ï¸'; 
        if (code <= 67) return 'ğŸŒ§ï¸'; 
        if (code <= 77) return 'â„ï¸'; 
        if (code <= 82) return 'ğŸŒ§ï¸'; 
        if (code <= 86) return 'ğŸŒ¨ï¸'; 
        if (code <= 99) return 'â›ˆï¸'; 
        return '';
    }

    async function analyzeWeather() {
        const loadingEl = document.getElementById('loading');
        loadingEl.style.display = 'block';

        try {
            const keys = Object.keys(locations);
            const promises = keys.map(key => {
                const loc = locations[key];
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&daily=temperature_2m_min,weathercode&timezone=auto&forecast_days=16`;
                return fetch(url).then(res => {
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return res.json();
                });
            });

            const results = await Promise.all(promises);
            loadingEl.style.display = 'none';

            const weatherData = {};
            const weatherCodes = {};
            const rawDates = results[0].daily.time;
            const displayLabels = rawDates.map(date => date.substring(5).replace('-', '/'));

            keys.forEach((key, index) => {
                weatherData[key] = results[index].daily.temperature_2m_min;
                weatherCodes[key] = results[index].daily.weathercode;
            });

            // --- æ¼”ç®—æ³• V10: ä»Šæ—¥éŒ¨å®š + ç‰©ç†è£œå„Ÿ ---
            const predictedTaipei = [];
            const shaData = weatherData['sha'];
            const wuhData = weatherData['wuh'];
            const tpeData = weatherData['tpe']; 
            
            const WEIGHT_SHA = 0.7; // æ±è·¯æ¬Šé‡ç¨é«˜
            const WEIGHT_WUH = 0.3;

            // 1. è¨ˆç®— Day 0 çš„åŸºæº–æº«å·® (Anchor Gap)
            // é€™ä»£è¡¨ã€Œä»Šå¤©ã€ç’°å¢ƒä¸‹çš„å¯¦éš›æº«å·®ï¼ŒåŒ…å«æµ·æ´‹ã€åœ°å½¢ã€é¢¨å‘çš„ç¸½å’Œæ•ˆæ‡‰
            const todaySource = (shaData[0] * WEIGHT_SHA) + (wuhData[0] * WEIGHT_WUH);
            const anchorGap = tpeData[0] - todaySource;

            // 2. é€²è¡Œæ¨æ¼”
            for(let i = 0; i < shaData.length; i++) {
                // Day 0 ç›´æ¥ä½¿ç”¨çœŸå¯¦å€¼
                if (i === 0) {
                    predictedTaipei.push(tpeData[0]); 
                } else {
                    // è¨ˆç®—æºé ­æº«åº¦ (Lag 1 day: ç”¨æ˜¨å¤©çš„æºé ­æ¨ç®—ä»Šå¤©çš„å°åŒ—)
                    const prevSha = shaData[i-1];
                    const prevWuh = wuhData[i-1];
                    const sourceTemp = (prevSha * WEIGHT_SHA) + (prevWuh * WEIGHT_WUH);
                    
                    // æ‡‰ç”¨åŸºæº–æº«å·®
                    let gap = anchorGap;

                    // ç‰©ç†è£œå„Ÿ (Physics Compensation)
                    // å†·ç©ºæ°£è¶Šå†·ï¼Œç¶“éæš–æµ·é¢æ™‚ï¼Œè®Šæ€§(å‡æº«)å¹…åº¦è¶Šå¤§
                    // ä»¥ 10åº¦ç‚ºåŸºæº–ï¼Œæ¯ä½ 1åº¦ï¼Œé¡å¤–å¢åŠ  0.2åº¦ çš„å‡æº«è£œå„Ÿ
                    if (sourceTemp < 10) {
                        gap += (10 - sourceTemp) * 0.2;
                    }
                    
                    // æš–å€è£œå„Ÿ
                    // å¦‚æœæºé ­å¾ˆæš– (>20)ï¼Œæµ·æ´‹èª¿ç¯€è®Šå¼±
                    if (sourceTemp > 20) {
                        gap -= (sourceTemp - 20) * 0.3;
                    }

                    let pred = sourceTemp + gap;

                    // æ…£æ€§å¹³æ»‘ (Smoothing)
                    // æ··åˆ 20% æ˜¨æ—¥é æ¸¬å€¼ï¼Œé¿å…ç·šæ¢é‹¸é½’
                    if (predictedTaipei[i-1] !== null) {
                        pred = (pred * 0.8) + (predictedTaipei[i-1] * 0.2);
                    }

                    predictedTaipei.push(pred);
                }
            }

            drawIntegratedChart(displayLabels, rawDates, weatherData, weatherCodes, predictedTaipei);

        } catch (error) {
            console.error(error);
            loadingEl.style.display = 'none';
            alert("âš ï¸ CONNECTION ERROR: " + error.message);
        }
    }

    function drawIntegratedChart(labels, rawDates, tempMap, codeMap, predTaipeiData) {
        const ctx = document.getElementById('weatherChart').getContext('2d');
        if (myChart) myChart.destroy();

        const gridColor = 'rgba(255, 255, 255, 0.1)';
        const textColor = '#ccc';
        const titleColor = '#eee';

        const createDataset = (key, axisId) => ({
            label: locations[key].name,
            data: tempMap[key],
            borderColor: locations[key].color,
            backgroundColor: locations[key].color,
            borderWidth: 2,
            pointRadius: 3,
            yAxisID: axisId,
            datalabels: {
                align: 'top',
                anchor: 'center',
                offset: 2,
                color: '#fff',
                font: { size: 11, weight: 'bold' },
                formatter: (value, ctx) => {
                    const code = codeMap[key][ctx.dataIndex];
                    return Math.round(value) + 'Â°\n' + getWeatherEmoji(code);
                },
                textAlign: 'center'
            }
        });

        const datasets = [
            createDataset('ham', 'yRow1'),
            createDataset('yak', 'yRow1'),
            createDataset('xia', 'yRow2'),
            createDataset('bei', 'yRow2'),
            createDataset('wuh', 'yRow3'),
            createDataset('sha', 'yRow3'),
            createDataset('tpe', 'yRow4'),
            
            {
                label: 'å°åŒ— (è¶¨å‹¢æ¨æ¼”)',
                data: predTaipeiData,
                borderColor: '#FF4081',
                backgroundColor: '#FF4081',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                pointHoverRadius: 6,
                yAxisID: 'yRow4',
                datalabels: {
                    align: 'bottom',
                    anchor: 'center',
                    offset: 6,
                    color: '#FF4081',
                    font: { size: 11, style: 'italic', weight: 'bold' },
                    formatter: (value) => {
                        if(value === null) return '';
                        return Math.round(value) + 'Â°';
                    }
                }
            }
        ];

        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets, rawDates },
            plugins: [weekendPlugin],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 20, bottom: 10, left: 10, right: 10 } },
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { 
                        grid: { display: false },
                        ticks: { color: textColor }
                    },
                    yRow1: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1, 
                        title: { display: true, text: 'å“ˆå¯† vs é›…åº«æ¬¡å…‹', color: titleColor, font: {weight:'bold'} },
                        grid: { color: gridColor },
                        ticks: { color: textColor }
                    },
                    yRow2: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'è¥¿å®‰ vs åŒ—äº¬', color: titleColor, font: {weight:'bold'} },
                        grid: { color: gridColor },
                        offset: true,
                        ticks: { color: textColor }
                    },
                    yRow3: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'æ­¦æ¼¢ vs ä¸Šæµ·', color: titleColor, font: {weight:'bold'} },
                        grid: { color: gridColor },
                        offset: true,
                        ticks: { color: textColor }
                    },
                    yRow4: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'å°åŒ— (é å ± vs æ¨æ¼”)', color: '#FF5252', font: {weight:'bold'} },
                        grid: { color: gridColor },
                        offset: true,
                        ticks: { color: textColor }
                    }
                },
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'top',
                        labels: { 
                            usePointStyle: true, 
                            padding: 15, 
                            font: {family: 'Segoe UI'},
                            color: textColor 
                        }
                    },
                    tooltip: { enabled: true }
                }
            }
        });
    }
    
    window.onload = analyzeWeather;
</script>

</body>
</html>