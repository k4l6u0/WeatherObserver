<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒè®Šå†·å˜¸ï¼Ÿ BUILD 260107ai (é«”æ„Ÿç‰ˆ)</title>
    <!-- ä½¿ç”¨ç©©å®šçš„ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <style>
        /* Dark Mode å…¨å±€è¨­å®š - å¼·åˆ¶æ¥µé»‘ */
        body { 
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; 
            background-color: #000000; 
            color: #e0e0e0; 
            margin: 0; padding: 20px; 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: #0a0a0a; 
            padding: 0; 
            border-radius: 16px; 
            box-shadow: 0 20px 50px rgba(255,255,255,0.05); 
            overflow: hidden; 
            border: 1px solid #333;
        }
        
        /* æ¨™é¡Œå€ */
        header { 
            background: linear-gradient(135deg, #2c3e50, #4ca1af); /* æ”¹ç‚ºç¨å¾®å†·è‰²èª¿çš„è—ç¶ æ¼¸å±¤ */
            padding: 25px 35px; 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #333;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(rgba(255,255,255,0.2) 15%, transparent 16%),
                radial-gradient(rgba(255,255,255,0.2) 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            opacity: 0.15;
            animation: snow 10s linear infinite;
        }
        @keyframes snow { from {background-position: 0 0, 30px 30px;} to {background-position: 0 60px, 30px 90px;} }

        /* å·¦å´æ¨™é¡Œå€ */
        .header-left { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: flex-start; }
        .header-left h1 { margin: 0; font-size: 2.2rem; font-weight: 900; letter-spacing: 2px; color: #a8ff78; text-shadow: 0 0 15px rgba(168, 255, 120, 0.4); }
        .build-tag-block { font-family: monospace; font-size: 0.8rem; color: #0a0a0a; background: #a8ff78; padding: 2px 8px; border-radius: 4px; font-weight: bold; margin-top: 8px; display: inline-block; }
        
        .hud-display { display: flex; gap: 15px; margin-top: 15px; font-size: 0.85rem; font-weight: 600; color: #999; }
        .hud-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 5px currentColor; }

        .header-right { position: relative; z-index: 2; }
        .reload-btn {
            background: rgba(168, 255, 120, 0.1); border: 1px solid rgba(168, 255, 120, 0.5); color: #a8ff78;
            padding: 10px 25px; border-radius: 30px; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;
        }
        .reload-btn:hover { background: rgba(168, 255, 120, 0.2); box-shadow: 0 0 20px rgba(168, 255, 120, 0.4); transform: translateY(-2px); }

        .content-body { padding: 10px 25px 25px 25px; }
        
        /* ç‹€æ…‹é¡¯ç¤ºæ¢ */
        #status-log { text-align: center; font-family: monospace; color: #666; margin: 10px 0; font-size: 0.8rem; padding: 5px; }
        .error-msg { color: #ff5252; font-weight: bold; }

        .chart-container { position: relative; height: 900px; width: 100%; margin-top: 10px; }

        footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #333; color: #555; font-size: 0.8rem; font-family: Consolas, monospace; }
        .version-tag { background: #333; padding: 2px 6px; border-radius: 3px; font-weight: bold; color: #ccc; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <h1>æœƒè®Šå†·å˜¸ï¼Ÿ (é«”æ„Ÿç‰ˆ)</h1>
            <span class="build-tag-block">BUILD 260107ai (Real Feel)</span>
            <div class="hud-display">
                <div class="hud-item"><span class="dot" style="background:#B388FF; box-shadow: 0 0 5px #B388FF"></span> è¥¿è·¯</div>
                <div class="hud-item"><span class="dot" style="background:#448AFF; box-shadow: 0 0 5px #448AFF"></span> æ±è·¯</div>
                <div class="hud-item"><span class="dot" style="background:#FF4081; box-shadow: 0 0 5px #FF4081"></span> AI æ¨æ¼”</div>
            </div>
        </div>
        <div class="header-right">
            <button class="reload-btn" onclick="analyzeWeather()">
                <span>âš¡</span> RELOAD
            </button>
        </div>
    </header>

    <div class="content-body">
        <div id="status-log">ç³»çµ±æº–å‚™å°±ç·’...</div>

        <!-- éš±è—åƒæ•¸ -->
        <div style="display:none;">
            <input type="number" id="windowDays" value="2">
            <input type="number" id="dropThreshold" value="3">
            <input type="number" id="lagMin" value="0"> 
            <input type="number" id="lagMax" value="3">
        </div>

        <div class="chart-container">
            <canvas id="weatherChart"></canvas>
        </div>

        <footer>
            <h3>System Logs</h3>
            <ul>
                <li><span class="version-tag">260107ai</span> <b>å…¨é«”æ„Ÿæ¨¡å¼ (Apparent Temp Mode)</b>ï¼š
                    <br>1. <b>æ•¸æ“šæºåˆ‡æ›</b>ï¼šæ‰€æœ‰åŸå¸‚æ°£æº«æ•¸æ“šæ”¹ç‚ºè®€å– <b>Apparent Minimum Temperature (æœ€ä½é«”æ„Ÿ)</b>ã€‚é€™åŒ…å«äº†æ¿•åº¦ã€é¢¨é€Ÿèˆ‡è¼»å°„å†·å»çš„ç¶œåˆå½±éŸ¿ã€‚
                    <br>2. <b>æ•¸å€¼é æœŸ</b>ï¼šé«”æ„Ÿæº«åº¦é€šå¸¸æ¯”å¯¦éš›æ°£æº«ä½ 2~5 åº¦ï¼ˆè¦–é¢¨é€Ÿè€Œå®šï¼‰ï¼Œå°¤å…¶åœ¨å¯’æµæœŸé–“å·®ç•°æœƒæ›´é¡¯è‘—ï¼Œæ­¤ç‚ºæ­£å¸¸ç¾è±¡ã€‚
                </li>
                <li><span class="version-tag">251216ah</span> é›™è»¸ä¿®å¾©+æ¥µé»‘èƒŒæ™¯ã€‚</li>
                <li><span class="version-tag">251215ad</span> æ¼”ç®—æ³•æ ¸å¿ƒï¼šä»Šæ—¥éŒ¨å®š + ç‰©ç†è£œå„Ÿæ¨¡å‹ (V10)ã€‚</li>
            </ul>
        </footer>
    </div>
</div>

<script>
    function updateStatus(msg, isError = false) {
        const el = document.getElementById('status-log');
        if (el) {
            el.innerHTML = msg;
            el.className = isError ? 'error-msg' : '';
        }
        console.log("[System]", msg);
    }

    if (typeof Chart === 'undefined') {
        updateStatus("éŒ¯èª¤ï¼šChart.js ç„¡æ³•è¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", true);
    } else {
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
        }
    }

    const locations = {
        ham: { name: 'å“ˆå¯† (è¥¿)', lat: 42.82, lon: 93.51, color: '#B388FF' },
        xia: { name: 'è¥¿å®‰ (è¥¿)', lat: 34.34, lon: 108.94, color: '#FFB74D' },
        wuh: { name: 'æ­¦æ¼¢ (è¥¿)', lat: 30.59, lon: 114.30, color: '#69F0AE' },
        yak: { name: 'é›…åº«æ¬¡å…‹ (æ±)', lat: 62.03, lon: 129.74, color: '#448AFF' },
        bei: { name: 'åŒ—äº¬ (æ±)', lat: 39.90, lon: 116.40, color: '#4DD0E1' },
        sha: { name: 'ä¸Šæµ· (æ±)', lat: 31.23, lon: 121.47, color: '#80DEEA' },
        tpe: { name: 'å°åŒ— (é å ±)', lat: 25.03, lon: 121.56, color: '#FF5252' }
    };

    let myChart = null;

    const weekendPlugin = {
        id: 'weekendPlugin',
        beforeDraw: (chart) => {
            const { ctx, chartArea: { top, bottom, height }, scales: { x } } = chart;
            ctx.save();
            x.ticks.forEach((tick, index) => {
                const dateStr = chart.data.rawDates[index];
                if (!dateStr) return;
                const dayOfWeek = new Date(dateStr).getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    const width = x.width / x.ticks.length;
                    const xPos = x.getPixelForTick(index) - (width / 2);
                    // æ¥µæ·¡ç™½ï¼Œèå…¥æ·±é»‘èƒŒæ™¯
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.03)'; 
                    ctx.fillRect(xPos, top, width, height);
                    // é€±æœ«æ–‡å­—æç¤º
                    ctx.fillStyle = '#444';
                    ctx.font = 'bold 10px "Segoe UI"';
                    ctx.textAlign = 'center';
                    ctx.fillText(dayOfWeek === 6 ? "SAT" : "SUN", x.getPixelForTick(index), top + 25);
                }
            });
            ctx.restore();
        }
    };

    function getWeatherEmoji(code) {
        if (code === undefined || code === null) return ''; 
        if (code === 0) return 'â˜€ï¸'; 
        if (code <= 3) return 'â˜ï¸'; 
        if (code <= 48) return 'ğŸŒ'; 
        if (code <= 67) return 'ğŸŒ§ï¸'; 
        if (code <= 77) return 'â„ï¸'; 
        if (code <= 82) return 'ğŸŒ§ï¸'; 
        if (code <= 86) return 'ğŸŒ¨ï¸'; 
        if (code <= 99) return 'â›ˆï¸'; 
        return '';
    }

    async function analyzeWeather() {
        updateStatus("ğŸ›°ï¸ é€£ç·šæ°£è±¡è¡›æ˜Ÿä¸­ (Connecting)...");

        try {
            const keys = Object.keys(locations);
            const promises = keys.map(key => {
                const loc = locations[key];
                // é—œéµä¿®æ”¹ï¼šæ”¹æŠ“å– apparent_temperature_min (é«”æ„Ÿæœ€ä½æº«)
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&daily=apparent_temperature_min,weathercode&timezone=auto&forecast_days=16`;
                return fetch(url).then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                });
            });

            const results = await Promise.all(promises);
            updateStatus("âš¡ æ•¸æ“šé‹ç®—ä¸­ (Calculating)...");

            const weatherData = {};
            const weatherCodes = {};
            const rawDates = results[0].daily.time;
            const displayLabels = rawDates.map(date => date.substring(5).replace('-', '/'));

            keys.forEach((key, index) => {
                // é€™è£¡å­˜å…¥çš„æ˜¯é«”æ„Ÿæº«åº¦
                weatherData[key] = results[index].daily.apparent_temperature_min;
                weatherCodes[key] = results[index].daily.weathercode;
            });

            // --- æ¼”ç®—æ³• V10: ä»Šæ—¥éŒ¨å®š + ç‰©ç†è£œå„Ÿ ---
            // é‚è¼¯ä¸è®Šï¼Œä½†å› ç‚ºè¼¸å…¥æ•¸æ“šè®Šæˆäº†é«”æ„Ÿï¼Œè¼¸å‡ºè‡ªç„¶ä¹Ÿæ˜¯é«”æ„Ÿæ¨æ¼”
            const predictedTaipei = [];
            const shaData = weatherData['sha'];
            const wuhData = weatherData['wuh'];
            const tpeData = weatherData['tpe']; 
            
            const WEIGHT_SHA = 0.7; 
            const WEIGHT_WUH = 0.3;

            const todaySource = (shaData[0] * WEIGHT_SHA) + (wuhData[0] * WEIGHT_WUH);
            let anchorGap = tpeData[0] - todaySource;
            if (isNaN(anchorGap)) anchorGap = 8.5;

            for(let i = 0; i < shaData.length; i++) {
                if (i === 0) {
                    predictedTaipei.push(tpeData[0]); 
                } else {
                    const prevSha = shaData[i-1];
                    const prevWuh = wuhData[i-1];
                    const sourceTemp = (prevSha * WEIGHT_SHA) + (prevWuh * WEIGHT_WUH);
                    
                    let gap = anchorGap;
                    if (sourceTemp < 10) gap += (10 - sourceTemp) * 0.2;
                    if (sourceTemp > 20) gap -= (sourceTemp - 20) * 0.3;

                    let pred = sourceTemp + gap;
                    if (predictedTaipei[i-1] !== null) {
                        pred = (pred * 0.8) + (predictedTaipei[i-1] * 0.2);
                    }
                    predictedTaipei.push(pred);
                }
            }

            updateStatus("ğŸ¨ ç¹ªè£½åœ–è¡¨ä¸­ (Rendering)...");
            drawIntegratedChart(displayLabels, rawDates, weatherData, weatherCodes, predictedTaipei);
            updateStatus("âœ… æ•¸æ“šæ›´æ–°å®Œæˆ (Last Update: " + new Date().toLocaleTimeString() + ")");

        } catch (error) {
            console.error(error);
            updateStatus("âš ï¸ ç™¼ç”ŸéŒ¯èª¤: " + error.message, true);
            alert("æŠ“å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚\néŒ¯èª¤ä»£ç¢¼: " + error.message);
        }
    }

    function drawIntegratedChart(labels, rawDates, tempMap, codeMap, predTaipeiData) {
        const ctx = document.getElementById('weatherChart').getContext('2d');
        if (myChart) myChart.destroy();

        const gridColor = 'rgba(255, 255, 255, 0.08)';
        const textColor = '#888';
        const titleColor = '#ccc';

        const createDataset = (key, axisId, fontSize = 12) => ({
            label: locations[key].name,
            data: tempMap[key],
            borderColor: locations[key].color,
            backgroundColor: locations[key].color,
            borderWidth: 2,
            pointRadius: 4, 
            yAxisID: axisId,
            datalabels: {
                align: 'top',
                anchor: 'center',
                offset: 4,
                color: '#fff',
                textStrokeColor: '#000', 
                textStrokeWidth: 3, 
                font: { size: fontSize, weight: 'bold' },
                formatter: (value, ctx) => {
                    const code = codeMap[key][ctx.dataIndex];
                    return Math.round(value) + 'Â°\n' + getWeatherEmoji(code);
                },
                textAlign: 'center'
            }
        });

        const datasets = [
            createDataset('ham', 'yRow1', 12),
            createDataset('yak', 'yRow1', 12),
            createDataset('xia', 'yRow2', 12),
            createDataset('bei', 'yRow2', 12),
            createDataset('wuh', 'yRow3', 12),
            createDataset('sha', 'yRow3', 12),
            
            // å°åŒ— (å®˜æ–¹é å ± - é«”æ„Ÿ)
            createDataset('tpe', 'yRow4', 15),
            
            // å°åŒ— (è¶¨å‹¢æ¨æ¼” - é«”æ„Ÿ)
            {
                label: 'å°åŒ— (è¶¨å‹¢æ¨æ¼”)',
                data: predTaipeiData,
                borderColor: '#FF4081',
                backgroundColor: '#FF4081',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                pointHoverRadius: 6,
                yAxisID: 'yRow4',
                datalabels: {
                    align: 'bottom',
                    anchor: 'center',
                    offset: 8,
                    color: '#FF4081',
                    textStrokeColor: '#000', 
                    textStrokeWidth: 3, 
                    font: { size: 15, style: 'italic', weight: 'bold' },
                    formatter: (value) => {
                        if(value === null) return '';
                        return Math.round(value) + 'Â°';
                    }
                }
            }
        ];

        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets, rawDates },
            plugins: [weekendPlugin],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 30, bottom: 20, left: 10, right: 10 } },
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { 
                        grid: { display: false },
                        ticks: { color: textColor, font: { size: 11 } }
                    },
                    // é ‚éƒ¨æ—¥æœŸè»¸ (x2)
                    x2: {
                        position: 'top',
                        grid: { display: false },
                        ticks: {
                            color: textColor,
                            font: { size: 11 },
                            callback: function(value, index) {
                                const label = this.getLabelForValue(value);
                                const dateStr = rawDates[index];
                                const dayMap = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                                const day = new Date(dateStr).getDay();
                                return `${label} (${dayMap[day]})`;
                            }
                        }
                    },
                    yRow1: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1, 
                        title: { display: true, text: 'å“ˆå¯† vs é›…åº«æ¬¡å…‹', color: titleColor, font: {weight:'bold'} },
                        grid: { color: gridColor },
                        ticks: { color: textColor }
                    },
                    yRow2: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'è¥¿å®‰ vs åŒ—äº¬', color: titleColor, font: {weight:'bold'} },
                        grid: { color: gridColor },
                        offset: true,
                        ticks: { color: textColor }
                    },
                    yRow3: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'æ­¦æ¼¢ vs ä¸Šæµ·', color: titleColor, font: {weight:'bold'} },
                        grid: { color: gridColor },
                        offset: true,
                        ticks: { color: textColor }
                    },
                    yRow4: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'å°åŒ— (é«”æ„Ÿ)', color: '#FF5252', font: {weight:'bold'} },
                        grid: { color: gridColor },
                        offset: true,
                        ticks: { color: textColor }
                    }
                },
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'top',
                        labels: { 
                            usePointStyle: true, 
                            padding: 20, 
                            font: {family: 'Segoe UI', size: 12},
                            color: textColor 
                        }
                    },
                    tooltip: { enabled: true }
                }
            }
        });
    }
    
    window.onload = analyzeWeather;
</script>

</body>
</html>