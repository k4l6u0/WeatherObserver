<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯’æµé›™è·¯å¾‘æ•´åˆå„€è¡¨æ¿ (çµ±ä¸€è»¸ç·šç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.08); }
        
        h1 { text-align: center; color: #2c3e50; margin: 0 0 10px 0; }
        .subtitle { text-align: center; color: #546e7a; font-size: 0.95rem; margin-bottom: 25px; line-height: 1.6; }
        
        /* é¡è‰²æ¨™è¨˜èªªæ˜ */
        .badge { padding: 3px 8px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.85em; margin: 0 4px; }
        .badge-west { background-color: #673AB7; } /* ç´«è‰²ç³» */
        .badge-east { background-color: #1976D2; } /* è—è‰²ç³» */

        /* æ§åˆ¶é¢æ¿ */
        .controls { display: flex; flex-wrap: wrap; gap: 15px; background: #eceff1; padding: 20px; border-radius: 8px; margin-bottom: 20px; align-items: flex-end; justify-content: center; }
        .control-group { display: flex; flex-direction: column; }
        label { font-size: 13px; font-weight: 700; margin-bottom: 5px; color: #37474f; }
        input { padding: 8px; border: 1px solid #cfd8dc; border-radius: 4px; width: 70px; text-align: center; font-weight: bold; }
        button { padding: 8px 25px; background-color: #263238; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; height: 36px; transition: 0.2s; }
        button:hover { background-color: #000; }

        /* è­¦å ±å€ */
        #result-area { margin-bottom: 20px; }
        .alert-box { padding: 15px; border-radius: 6px; margin-bottom: 10px; display: none; font-size: 0.95rem; border-left: 5px solid; }
        .alert-danger { background-color: #fff3e0; color: #bf360c; border-color: #ff5722; }
        .alert-success { background-color: #e8f5e9; color: #2e7d32; border-color: #4caf50; }
        
        .log-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .log-col h4 { margin: 0 0 10px 0; text-align: center; padding-bottom: 5px; border-bottom: 2px solid #eee; }
        .log-item { background: #fafafa; padding: 10px; margin-bottom: 8px; border-radius: 4px; font-size: 0.9em; line-height: 1.4; border: 1px solid #eee; }
        .log-west { border-left: 4px solid #673AB7; }
        .log-east { border-left: 4px solid #1976D2; }

        /* åœ–è¡¨å€ */
        .chart-container { position: relative; height: 900px; width: 100%; }
        
        .loading { text-align: center; display: none; color: #78909c; font-weight: bold; margin: 20px 0; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: #37474f; animation: spin 1s infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* RWD */
        @media (max-width: 768px) {
            .log-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>âš”ï¸ å¯’æµé›™è·¯å¾‘æ•´åˆå„€è¡¨æ¿</h1>
    <div class="subtitle">
        <span class="badge badge-west">è¥¿è·¯ (å…§é™¸)</span> å“ˆå¯† â” è¥¿å®‰ â” æ­¦æ¼¢<br>
        <span class="badge badge-east">æ±è·¯ (æ²¿æµ·)</span> é›…åº«æ¬¡å…‹ â” åŒ—äº¬ â” ä¸Šæµ·<br>
        (æ‰€æœ‰å±¤ç´šçš†å…±ç”¨å·¦å´ Y è»¸ï¼ŒçœŸå¯¦å‘ˆç¾æº«å·®)
    </div>

    <div class="controls">
        <div class="control-group">
            <label style="color:#d32f2f;">é€£çºŒé™æº«å¤©æ•¸</label>
            <input type="number" id="windowDays" value="2" min="1" max="5">
        </div>
        <div class="control-group">
            <label>ç´¯ç©é™æº«é–€æª»(Â°C)</label>
            <input type="number" id="dropThreshold" value="3" min="1">
        </div>
        <div class="control-group">
            <label>å‚³å°å»¶é² (æœ€å°‘å¤©)</label>
            <input type="number" id="lagMin" value="0" min="0"> 
        </div>
        <div class="control-group">
            <label>å‚³å°å»¶é² (æœ€å¤šå¤©)</label>
            <input type="number" id="lagMax" value="3" min="0">
        </div>
        <button onclick="analyzeWeather()">ğŸ”„ æ›´æ–°å°ç…§åˆ†æ</button>
    </div>

    <div id="loading" class="loading"><span class="spinner"></span>æ­£åœ¨æŠ“å– 7 å€‹åŸå¸‚çš„æ°£è±¡è³‡æ–™...</div>

    <div id="result-area">
        <div id="statusBox" class="alert-box"></div>
        <div class="log-container">
            <div class="log-col">
                <h4 style="color:#673AB7">è¥¿è·¯è­¦ç¤º (West)</h4>
                <div id="logWest"></div>
            </div>
            <div class="log-col">
                <h4 style="color:#1976D2">æ±è·¯è­¦ç¤º (East)</h4>
                <div id="logEast"></div>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="weatherChart"></canvas>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);

    const locations = {
        // --- è¥¿è·¯ ---
        ham: { name: 'å“ˆå¯† (è¥¿)', lat: 42.82, lon: 93.51, color: '#673AB7' },
        xia: { name: 'è¥¿å®‰ (è¥¿)', lat: 34.34, lon: 108.94, color: '#FF9800' },
        wuh: { name: 'æ­¦æ¼¢ (è¥¿)', lat: 30.59, lon: 114.30, color: '#4CAF50' },
        
        // --- æ±è·¯ ---
        yak: { name: 'é›…åº«æ¬¡å…‹ (æ±)', lat: 62.03, lon: 129.74, color: '#1565C0' },
        bei: { name: 'åŒ—äº¬ (æ±)', lat: 39.90, lon: 116.40, color: '#039BE5' },
        sha: { name: 'ä¸Šæµ· (æ±)', lat: 31.23, lon: 121.47, color: '#0097A7' },

        // --- ç›®æ¨™ ---
        tpe: { name: 'å°åŒ—', lat: 25.03, lon: 121.56, color: '#D32F2F' }
    };

    let myChart = null;

    const weekendPlugin = {
        id: 'weekendPlugin',
        beforeDraw: (chart) => {
            const { ctx, chartArea: { top, bottom, height }, scales: { x } } = chart;
            ctx.save();
            x.ticks.forEach((tick, index) => {
                const dateStr = chart.data.rawDates[index];
                if (!dateStr) return;
                const dayOfWeek = new Date(dateStr).getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    const width = x.width / x.ticks.length;
                    const xPos = x.getPixelForTick(index) - (width / 2);
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                    ctx.fillRect(xPos, top, width, height);
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 11px "Microsoft JhengHei"';
                    ctx.textAlign = 'center';
                    ctx.fillText(dayOfWeek === 6 ? "é€±å…­" : "é€±æ—¥", x.getPixelForTick(index), top + 15);
                }
            });
            ctx.restore();
        }
    };

    function getWeatherEmoji(code) {
        if (code === 0) return 'â˜€ï¸'; 
        if (code <= 3) return 'â˜ï¸'; 
        if (code <= 48) return 'ğŸŒ«ï¸'; 
        if (code <= 67) return 'ğŸŒ§ï¸'; 
        if (code <= 77) return 'â„ï¸'; 
        if (code <= 82) return 'ğŸŒ§ï¸'; 
        if (code <= 86) return 'ğŸŒ¨ï¸'; 
        if (code <= 99) return 'â›ˆï¸'; 
        return '';
    }

    async function analyzeWeather() {
        const threshold = parseFloat(document.getElementById('dropThreshold').value);
        const windowDays = parseInt(document.getElementById('windowDays').value);
        const lagMin = parseInt(document.getElementById('lagMin').value);
        const lagMax = parseInt(document.getElementById('lagMax').value);
        
        document.getElementById('loading').style.display = 'block';
        document.getElementById('statusBox').style.display = 'none';
        document.getElementById('logWest').innerHTML = '';
        document.getElementById('logEast').innerHTML = '';

        try {
            const keys = Object.keys(locations);
            const promises = keys.map(key => {
                const loc = locations[key];
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&daily=temperature_2m_min,weathercode&timezone=auto&forecast_days=16`;
                return fetch(url).then(res => res.json());
            });

            const results = await Promise.all(promises);
            document.getElementById('loading').style.display = 'none';

            const weatherData = {};
            const weatherCodes = {};
            const rawDates = results[0].daily.time;
            const displayLabels = rawDates.map(date => date.substring(5).replace('-', '/'));

            keys.forEach((key, index) => {
                weatherData[key] = results[index].daily.temperature_2m_min;
                weatherCodes[key] = results[index].daily.weathercode;
            });

            drawIntegratedChart(displayLabels, rawDates, weatherData, weatherCodes);

            let totalAlerts = 0;
            const alertsWest = runPathLogic('ham', 'xia', 'wuh', 'tpe', weatherData, displayLabels, threshold, windowDays, lagMin, lagMax);
            const alertsEast = runPathLogic('yak', 'bei', 'sha', 'tpe', weatherData, displayLabels, threshold, windowDays, lagMin, lagMax);

            renderLogs('logWest', alertsWest, 'log-west');
            renderLogs('logEast', alertsEast, 'log-east');
            
            totalAlerts = alertsWest.length + alertsEast.length;
            const statusBox = document.getElementById('statusBox');
            if (totalAlerts > 0) {
                statusBox.className = 'alert-box alert-danger';
                statusBox.innerHTML = `âš ï¸ åµæ¸¬åˆ° <b>${totalAlerts}</b> å€‹ç¬¦åˆæ¢ä»¶çš„å¯’æµé™æº«è¨Šè™Ÿã€‚`;
                statusBox.style.display = 'block';
            } else {
                statusBox.className = 'alert-box alert-success';
                statusBox.innerHTML = `âœ… æœªä¾† 16 å¤©å…§ï¼Œæ±è¥¿å…©è·¯å‡æœªåµæ¸¬åˆ°é¡¯è‘—é€£é–é™æº«è¨Šè™Ÿã€‚`;
                statusBox.style.display = 'block';
            }

        } catch (error) {
            console.error(error);
            document.getElementById('loading').style.display = 'none';
        }
    }

    function runPathLogic(idA, idB, idC, idD, dataMap, dates, threshold, windowDays, lagMin, lagMax) {
        let alerts = [];
        const dataA = dataMap[idA];
        const dataB = dataMap[idB];
        const dataC = dataMap[idC];
        const maxScanDay = dataA.length - windowDays - (lagMax * 2);

        for (let i = 0; i < maxScanDay; i++) {
            let dropA = dataA[i] - dataA[i + windowDays];
            if (dropA >= threshold) {
                for (let d1 = lagMin; d1 <= lagMax; d1++) {
                    let idxB = i + d1;
                    if (idxB + windowDays >= dataB.length) continue;
                    let dropB = dataB[idxB] - dataB[idxB + windowDays];
                    if (dropB >= threshold) {
                        for (let d2 = lagMin; d2 <= lagMax; d2++) {
                            let idxC = idxB + d2;
                            if (idxC + windowDays >= dataC.length) continue;
                            let dropC = dataC[idxC] - dataC[idxC + windowDays];
                            if (dropC >= threshold) {
                                let dateA = dates[i];
                                let dateC = dates[idxC];
                                let id = `${dateA}-${dateC}`;
                                if (!alerts.some(a => a.id === id)) {
                                    alerts.push({
                                        id: id,
                                        msg: `<b>${dateA}</b> èµ·å§‹:<br>æºé ­é™ ${dropA.toFixed(1)}Â° â” å—æ–¹(${dateC})é™ ${dropC.toFixed(1)}Â°`
                                    });
                                }
                            }
                        }
                    }
                }
            }
        }
        return alerts;
    }

    function renderLogs(elementId, alerts, cssClass) {
        const container = document.getElementById(elementId);
        if (alerts.length === 0) {
            container.innerHTML = '<div style="color:#999; font-style:italic;">ç„¡è¨Šè™Ÿ</div>';
            return;
        }
        alerts.forEach(a => {
            const d = document.createElement('div');
            d.className = `log-item ${cssClass}`;
            d.innerHTML = a.msg;
            container.appendChild(d);
        });
    }

    function drawIntegratedChart(labels, rawDates, tempMap, codeMap) {
        const ctx = document.getElementById('weatherChart').getContext('2d');
        if (myChart) myChart.destroy();

        const createDataset = (key, axisId) => ({
            label: locations[key].name,
            data: tempMap[key],
            borderColor: locations[key].color,
            backgroundColor: locations[key].color,
            borderWidth: 2,
            pointRadius: 3,
            yAxisID: axisId,
            datalabels: {
                align: 'top',
                anchor: 'center',
                offset: 2,
                color: '#333',
                font: { size: 12, weight: 'bold', family: 'Segoe UI Emoji' },
                formatter: (value, ctx) => {
                    const code = codeMap[key][ctx.dataIndex];
                    return Math.round(value) + 'Â°\n' + getWeatherEmoji(code);
                },
                textAlign: 'center'
            }
        });

        // 4 å±¤å †ç–Šï¼Œæ¯å±¤éƒ½ä½¿ç”¨åŒä¸€å€‹ 'left' Y è»¸è¨­å®š
        // stackWeight: 1 ç¢ºä¿å››å±¤é«˜åº¦å¹³å‡
        
        const datasets = [
            // ç¬¬ä¸€å±¤ (Row 1): å“ˆå¯† vs é›…åº«æ¬¡å…‹
            createDataset('ham', 'yRow1'),
            createDataset('yak', 'yRow1'),

            // ç¬¬äºŒå±¤ (Row 2): è¥¿å®‰ vs åŒ—äº¬
            createDataset('xia', 'yRow2'),
            createDataset('bei', 'yRow2'),

            // ç¬¬ä¸‰å±¤ (Row 3): æ­¦æ¼¢ vs ä¸Šæµ·
            createDataset('wuh', 'yRow3'),
            createDataset('sha', 'yRow3'),

            // ç¬¬å››å±¤ (Row 4): å°åŒ—
            createDataset('tpe', 'yRow4')
        ];

        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets, rawDates },
            plugins: [weekendPlugin],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 20, bottom: 10, left: 10, right: 10 } },
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { grid: { drawOnChartArea: false } },
                    
                    // é€™è£¡å®šç¾© 4 å€‹åˆ†å±¤çš„ Y è»¸
                    // æ³¨æ„ï¼šä¸å†æœ‰ yEast1 (å³è»¸)ï¼Œå…¨éƒ¨é å·¦å°é½Š
                    yRow1: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1, 
                        title: { display: true, text: 'å“ˆå¯† vs é›…åº«æ¬¡å…‹', color: '#444', font: {weight:'bold'} },
                        grid: { color: '#eee' }
                    },
                    yRow2: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'è¥¿å®‰ vs åŒ—äº¬', color: '#444', font: {weight:'bold'} },
                        grid: { color: '#eee' },
                        offset: true
                    },
                    yRow3: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'æ­¦æ¼¢ vs ä¸Šæµ·', color: '#444', font: {weight:'bold'} },
                        grid: { color: '#eee' },
                        offset: true
                    },
                    yRow4: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'å°åŒ—', color: '#D32F2F', font: {weight:'bold'} },
                        grid: { color: '#eee' },
                        offset: true
                    }
                },
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'top',
                        labels: { usePointStyle: true, padding: 15 }
                    },
                    tooltip: { enabled: true }
                }
            }
        });
    }
</script>

</body>
</html>