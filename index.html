<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Where is Snowman? build 25121209</title>
    <!-- ä½¿ç”¨ç©©å®šçš„ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <style>
        /* Dark Mode å…¨å±€è¨­å®š */
        body { 
            font-family: "Segoe UI", "Roboto", "Microsoft JhengHei", sans-serif; 
            background-color: #121212; /* æ·±é»‘èƒŒæ™¯ */
            color: #e0e0e0; /* æ·ºè‰²æ–‡å­— */
            margin: 0; padding: 20px; 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: #1e1e1e; /* å¡ç‰‡æ·±è‰²èƒŒæ™¯ */
            padding: 0; 
            border-radius: 16px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            overflow: hidden; 
            border: 1px solid #333;
        }
        
        /* æ¨™é¡Œå€ - å†°éœœæ¼¸å±¤ */
        header { 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); 
            padding: 25px 35px; 
            color: white; 
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }
        
        /* é›ªèŠ±å‹•æ•ˆä¿ç•™ï¼Œèª¿æ•´é€æ˜åº¦é©æ‡‰é»‘åº• */
        header::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(rgba(255,255,255,0.2) 15%, transparent 16%),
                radial-gradient(rgba(255,255,255,0.2) 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            opacity: 0.2;
            animation: snow 10s linear infinite;
        }
        @keyframes snow { from {background-position: 0 0, 30px 30px;} to {background-position: 0 60px, 30px 90px;} }

        /* å·¦å´æ¨™é¡Œå€ */
        .header-left { position: relative; z-index: 2; }
        h1 { margin: 0; font-size: 2.2rem; font-weight: 900; letter-spacing: 1px; color: #4fc3f7; text-shadow: 0 0 10px rgba(79, 195, 247, 0.3); }
        .subtitle { font-size: 0.9rem; color: #b0bec5; margin-top: 5px; font-weight: 400; }
        .build-ver { font-size: 0.4em; opacity: 0.7; font-weight: normal; border: 1px solid #4fc3f7; color: #4fc3f7; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 10px;}
        
        .hud-display {
            display: flex; gap: 15px; margin-top: 12px; font-size: 0.85rem; font-weight: 600; color: #ccc;
        }
        .hud-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 5px currentColor; }

        /* å³å´æŒ‰éˆ•å€ */
        .header-right { position: relative; z-index: 2; }
        .reload-btn {
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.5);
            color: #4fc3f7;
            padding: 10px 25px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.1);
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .reload-btn:hover {
            background: rgba(79, 195, 247, 0.2);
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.4);
            transform: translateY(-2px);
        }

        /* å…§å®¹å€ */
        .content-body { padding: 10px 25px 25px 25px; }

        /* åœ–è¡¨å€ */
        .chart-container { position: relative; height: 850px; width: 100%; margin-top: 20px; }
        .loading { text-align: center; display: none; color: #4fc3f7; font-weight: bold; margin: 50px 0; font-size: 1.2rem; letter-spacing: 2px; }

        /* Footer */
        footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #333; color: #777; font-size: 0.8rem; font-family: Consolas, monospace; }
        footer h3 { font-size: 0.9rem; margin-bottom: 10px; color: #aaa; text-transform: uppercase; }
        .version-tag { background: #333; padding: 2px 6px; border-radius: 3px; font-weight: bold; color: #eee; margin-right: 5px; border: 1px solid #555; }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 15px; text-align: center; }
            .hud-display { justify-content: center; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <h1>Where is Snowman? <span class="build-ver">build 25121209</span></h1>
            <div class="subtitle">è¿½è¹¤è¥¿ä¼¯åˆ©äºçš„è…³æ­¥ Â· å¯’æµé›™è·¯å¾‘åµæ¸¬</div>
            <div class="hud-display">
                <div class="hud-item"><span class="dot" style="background:#B388FF"></span> è¥¿è·¯</div>
                <div class="hud-item"><span class="dot" style="background:#448AFF"></span> æ±è·¯</div>
                <div class="hud-item"><span class="dot" style="background:#FF4081"></span> AI æ¨æ¼”</div>
            </div>
        </div>
        <div class="header-right">
            <button class="reload-btn" onclick="analyzeWeather()">
                <span>â„ï¸</span> SCAN
            </button>
        </div>
    </header>

    <div class="content-body">
        
        <div id="loading" class="loading">ğŸ›°ï¸ SCANNING ATMOSPHERE...</div>

        <div class="chart-container">
            <canvas id="weatherChart"></canvas>
        </div>

        <footer>
            <h3>Mission Logs</h3>
            <ul>
                <li><span class="version-tag">build 25121209</span> <b>Dark Mode Activated</b>ï¼šä»‹é¢å…¨é¢æš—é»‘åŒ–ï¼Œæå‡æ•¸æ“šå¯è®€æ€§èˆ‡æ²ˆæµ¸æ„Ÿã€‚åœ–è¡¨é…è‰²å„ªåŒ–ï¼šæ–‡å­—èˆ‡æ ¼ç·šèª¿æ•´ç‚ºæ·ºè‰²é«˜å°æ¯”ï¼Œç¢ºä¿åœ¨æ·±è‰²èƒŒæ™¯ä¸‹ä¾ç„¶æ¸…æ™°ã€‚</li>
                <li><span class="version-tag">build 25121208</span> æ¼”ç®—æ³•å„ªåŒ–ï¼šé‚è¼¯å›æ»¾è‡³å›ºå®šåŸºæ•¸ (+8Â°C) ä¸¦åŠ å…¥é«˜æº«æŠ‘åˆ¶æ©Ÿåˆ¶ (Cap > 18Â°C)ã€‚</li>
            </ul>
        </footer>
    </div>
</div>

<script>
    try {
        if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);
    } catch (e) { console.error(e); }

    const locations = {
        // ç‚ºäº†åœ¨æš—é»‘æ¨¡å¼ä¸‹æ›´æ¸…æ¥šï¼Œç¨å¾®èª¿äº®äº†åŸæœ¬çš„é¡è‰²
        ham: { name: 'å“ˆå¯† (è¥¿)', lat: 42.82, lon: 93.51, color: '#B388FF' }, // æ·ºç´«
        xia: { name: 'è¥¿å®‰ (è¥¿)', lat: 34.34, lon: 108.94, color: '#FFB74D' }, // æ·ºæ©˜
        wuh: { name: 'æ­¦æ¼¢ (è¥¿)', lat: 30.59, lon: 114.30, color: '#69F0AE' }, // è¢å…‰ç¶ 
        
        yak: { name: 'é›…åº«æ¬¡å…‹ (æ±)', lat: 62.03, lon: 129.74, color: '#448AFF' }, // äº®è—
        bei: { name: 'åŒ—äº¬ (æ±)', lat: 39.90, lon: 116.40, color: '#4DD0E1' }, // é’è‰²
        sha: { name: 'ä¸Šæµ· (æ±)', lat: 31.23, lon: 121.47, color: '#80DEEA' }, // æ·ºé’

        tpe: { name: 'å°åŒ— (é å ±)', lat: 25.03, lon: 121.56, color: '#FF5252' } // äº®ç´…
    };

    let myChart = null;

    // æš—é»‘ç‰ˆé€±æœ«èƒŒæ™¯æ’ä»¶
    const weekendPlugin = {
        id: 'weekendPlugin',
        beforeDraw: (chart) => {
            const { ctx, chartArea: { top, bottom, height }, scales: { x } } = chart;
            ctx.save();
            x.ticks.forEach((tick, index) => {
                const dateStr = chart.data.rawDates[index];
                if (!dateStr) return;
                const dayOfWeek = new Date(dateStr).getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    const width = x.width / x.ticks.length;
                    const xPos = x.getPixelForTick(index) - (width / 2);
                    // æ”¹ç‚ºæ·ºç™½è‰²åŠé€æ˜ï¼Œåœ¨é»‘åº•ä¸Šå‘ˆç¾å¾®äº®å€å¡Š
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.05)'; 
                    ctx.fillRect(xPos, top, width, height);
                    ctx.fillStyle = '#888'; // é€±æœ«æ–‡å­—é¡è‰²
                    ctx.font = 'bold 10px "Segoe UI"';
                    ctx.textAlign = 'center';
                    ctx.fillText(dayOfWeek === 6 ? "SAT" : "SUN", x.getPixelForTick(index), top + 15);
                }
            });
            ctx.restore();
        }
    };

    function getWeatherEmoji(code) {
        if (code === undefined || code === null) return ''; 
        if (code === 0) return 'â˜€ï¸'; 
        if (code <= 3) return 'â˜ï¸'; 
        if (code <= 48) return 'ğŸŒ«ï¸'; 
        if (code <= 67) return 'ğŸŒ§ï¸'; 
        if (code <= 77) return 'â„ï¸'; 
        if (code <= 82) return 'ğŸŒ§ï¸'; 
        if (code <= 86) return 'ğŸŒ¨ï¸'; 
        if (code <= 99) return 'â›ˆï¸'; 
        return '';
    }

    async function analyzeWeather() {
        const loadingEl = document.getElementById('loading');
        loadingEl.style.display = 'block';

        try {
            const keys = Object.keys(locations);
            const promises = keys.map(key => {
                const loc = locations[key];
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&daily=temperature_2m_min,weathercode&timezone=auto&forecast_days=16`;
                
                return fetch(url).then(res => {
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return res.json();
                });
            });

            const results = await Promise.all(promises);
            loadingEl.style.display = 'none';

            const weatherData = {};
            const weatherCodes = {};
            const rawDates = results[0].daily.time;
            const displayLabels = rawDates.map(date => date.substring(5).replace('-', '/'));

            keys.forEach((key, index) => {
                weatherData[key] = results[index].daily.temperature_2m_min;
                weatherCodes[key] = results[index].daily.weathercode;
            });

            // --- æ¼”ç®—æ³• V5 (åŒä¸Šå€‹ç‰ˆæœ¬) ---
            const predictedTaipei = [];
            const shaData = weatherData['sha'];
            const wuhData = weatherData['wuh'];
            const beiData = weatherData['bei']; 
            const xiaData = weatherData['xia'];
            
            const WEIGHT_SHA = 0.6;
            const WEIGHT_WUH = 0.4;
            const FIXED_BASE_OFFSET = 8; 
            const TEMP_CAP_START = 18; 
            const SURGE_THRESHOLD = 6; 

            for(let i = 0; i < shaData.length; i++) {
                if (i < 2) {
                    predictedTaipei.push(null);
                } else {
                    const prevShaAvg = (shaData[i-1] + shaData[i-2]) / 2;
                    const prevWuhAvg = (wuhData[i-1] + wuhData[i-2]) / 2;
                    const sourceTemp = (prevShaAvg * WEIGHT_SHA) + (prevWuhAvg * WEIGHT_WUH);
                    
                    let currentOffset = FIXED_BASE_OFFSET;
                    if (i >= 3) {
                        const dropBei = beiData[i-3] - beiData[i-1];
                        const dropXia = xiaData[i-3] - xiaData[i-1];
                        if (dropBei > SURGE_THRESHOLD || dropXia > SURGE_THRESHOLD) {
                            currentOffset *= 0.8; 
                        }
                    }

                    let pred = sourceTemp + currentOffset;
                    if (pred > TEMP_CAP_START) {
                        const excess = pred - TEMP_CAP_START;
                        pred = TEMP_CAP_START + (excess * 0.5);
                    }
                    predictedTaipei.push(pred);
                }
            }

            drawIntegratedChart(displayLabels, rawDates, weatherData, weatherCodes, predictedTaipei);

        } catch (error) {
            console.error(error);
            loadingEl.style.display = 'none';
            alert("âš ï¸ CONNECTION ERROR: " + error.message);
        }
    }

    function drawIntegratedChart(labels, rawDates, tempMap, codeMap, predTaipeiData) {
        const ctx = document.getElementById('weatherChart').getContext('2d');
        if (myChart) myChart.destroy();

        // è¼”åŠ©è®Šæ•¸ï¼šæ ¼ç·šèˆ‡æ–‡å­—é¡è‰² (Dark Mode)
        const gridColor = 'rgba(255, 255, 255, 0.1)';
        const textColor = '#ccc';
        const titleColor = '#eee';

        const createDataset = (key, axisId) => ({
            label: locations[key].name,
            data: tempMap[key],
            borderColor: locations[key].color,
            backgroundColor: locations[key].color,
            borderWidth: 2,
            pointRadius: 3,
            yAxisID: axisId,
            datalabels: {
                align: 'top',
                anchor: 'center',
                offset: 2,
                color: '#fff', // æ•¸æ“šæ¨™ç±¤æ”¹ç‚ºå…¨ç™½
                font: { size: 11, weight: 'bold' },
                formatter: (value, ctx) => {
                    const code = codeMap[key][ctx.dataIndex];
                    return Math.round(value) + 'Â°\n' + getWeatherEmoji(code);
                },
                textAlign: 'center'
            }
        });

        const datasets = [
            createDataset('ham', 'yRow1'),
            createDataset('yak', 'yRow1'),
            createDataset('xia', 'yRow2'),
            createDataset('bei', 'yRow2'),
            createDataset('wuh', 'yRow3'),
            createDataset('sha', 'yRow3'),
            createDataset('tpe', 'yRow4'),
            
            // è™›ç·šæ¨æ¼”
            {
                label: 'å°åŒ— (è¶¨å‹¢æ¨æ¼”)',
                data: predTaipeiData,
                borderColor: '#FF4081', // äº®æ´‹ç´… (Neon Pink)
                backgroundColor: '#FF4081',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                pointHoverRadius: 6,
                yAxisID: 'yRow4',
                datalabels: {
                    align: 'bottom',
                    anchor: 'center',
                    offset: 6,
                    color: '#FF4081',
                    font: { size: 11, style: 'italic', weight: 'bold' },
                    formatter: (value) => {
                        if(value === null) return '';
                        return Math.round(value) + 'Â°';
                    }
                }
            }
        ];

        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets, rawDates },
            plugins: [weekendPlugin],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 20, bottom: 10, left: 10, right: 10 } },
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { 
                        grid: { display: false },
                        ticks: { color: textColor }
                    },
                    yRow1: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1, 
                        title: { display: true, text: 'å“ˆå¯† vs é›…åº«æ¬¡å…‹', color: titleColor, font: {weight:'bold'} },
                        grid: { color: gridColor }, // æ·ºè‰²æ ¼ç·š
                        ticks: { color: textColor }
                    },
                    yRow2: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'è¥¿å®‰ vs åŒ—äº¬', color: titleColor, font: {weight:'bold'} },
                        grid: { color: gridColor },
                        offset: true,
                        ticks: { color: textColor }
                    },
                    yRow3: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'æ­¦æ¼¢ vs ä¸Šæµ·', color: titleColor, font: {weight:'bold'} },
                        grid: { color: gridColor },
                        offset: true,
                        ticks: { color: textColor }
                    },
                    yRow4: {
                        type: 'linear', position: 'left',
                        stack: 'mainStack', stackWeight: 1,
                        title: { display: true, text: 'å°åŒ— (é å ± vs æ¨æ¼”)', color: '#FF5252', font: {weight:'bold'} },
                        grid: { color: gridColor },
                        offset: true,
                        ticks: { color: textColor }
                    }
                },
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'top',
                        labels: { 
                            usePointStyle: true, 
                            padding: 15, 
                            font: {family: 'Segoe UI'},
                            color: textColor // åœ–ä¾‹æ–‡å­—æ”¹æ·ºè‰²
                        }
                    },
                    tooltip: { enabled: true }
                }
            }
        });
    }
    
    // è‡ªå‹•åŸ·è¡Œ
    window.onload = analyzeWeather;
</script>

</body>
</html>