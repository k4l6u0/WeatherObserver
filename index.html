<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯’æµåˆ†å±¤é è­¦å„€è¡¨æ¿ (é€±æœ«æ¨™ç¤ºç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #2c3e50; margin: 0 0 5px 0; }
        .subtitle { text-align: center; color: #7f8c8d; font-size: 0.9rem; margin-bottom: 20px; }
        
        /* æ§åˆ¶å€ */
        .controls { display: flex; flex-wrap: wrap; gap: 15px; background: #eceff1; padding: 15px; border-radius: 8px; margin-bottom: 20px; align-items: flex-end; justify-content: center; }
        .control-group { display: flex; flex-direction: column; }
        label { font-size: 13px; font-weight: 600; margin-bottom: 4px; color: #455a64; }
        input { padding: 8px; border: 1px solid #cfd8dc; border-radius: 4px; width: 70px; text-align: center; }
        button { padding: 8px 20px; background-color: #37474f; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; height: 36px; }
        button:hover { background-color: #263238; }

        /* è­¦å ±å€ */
        #result-area { margin-bottom: 20px; }
        .alert-box { padding: 15px; border-radius: 6px; margin-bottom: 10px; display: none; font-size: 0.95rem; }
        .alert-danger { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .alert-success { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .log-item { background: #fff; border-left: 4px solid #d32f2f; padding: 12px; margin-bottom: 8px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); line-height: 1.5; }
        
        /* åœ–è¡¨å€ */
        .chart-container { position: relative; height: 800px; width: 100%; } 
        
        .loading { text-align: center; display: none; color: #78909c; font-weight: bold; margin: 20px 0; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: #37474f; animation: spin 1s infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“‰ å¯’æµåˆ†å±¤ç›£æ¸¬å„€è¡¨æ¿</h1>
    <div class="subtitle">è‡ªå‹•æ¨™ç¤ºé€±æœ« (é€±å…­/é€±æ—¥)ï¼ŒèƒŒæ™¯è‰²èª¿å·²å„ªåŒ–</div>

    <div class="controls">
        <div class="control-group">
            <label style="color:#d32f2f;">é€£çºŒé™æº«å¤©æ•¸</label>
            <input type="number" id="windowDays" value="2" min="1" max="5">
        </div>
        <div class="control-group">
            <label>ç´¯ç©é™æº«é–€æª»(Â°C)</label>
            <input type="number" id="dropThreshold" value="3" min="1">
        </div>
        <div class="control-group">
            <label>å‚³å°å»¶é² (æœ€å°‘å¤©)</label>
            <input type="number" id="lagMin" value="0" min="0"> 
        </div>
        <div class="control-group">
            <label>å‚³å°å»¶é² (æœ€å¤šå¤©)</label>
            <input type="number" id="lagMax" value="3" min="0">
        </div>
        <button onclick="analyzeWeather()">æ›´æ–°åˆ†æ</button>
    </div>

    <div id="loading" class="loading"><span class="spinner"></span>æ­£åœ¨é€£ç·š Open-Meteo æ°£è±¡è¡›æ˜Ÿ...</div>

    <div id="result-area">
        <div id="statusBox" class="alert-box"></div>
        <div id="logContent"></div>
    </div>

    <div class="chart-container">
        <canvas id="weatherChart"></canvas>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);

    const cities = [
        { id: 'A', name: 'é›…åº«æ¬¡å…‹ (æºé ­)', lat: 62.03, lon: 129.74, color: '#1976D2', axis: 'yA' },
        { id: 'B', name: 'åŒ—äº¬ (ä¸­ç¹¼)', lat: 39.90, lon: 116.40, color: '#F57C00', axis: 'yB' },
        { id: 'C', name: 'ä¸Šæµ· (ä¸­ç¹¼)', lat: 31.23, lon: 121.47, color: '#388E3C', axis: 'yC' },
        { id: 'D', name: 'å°åŒ— (ç›®æ¨™)', lat: 25.03, lon: 121.56, color: '#D32F2F', axis: 'yD' }
    ];

    let myChart = null;

    // --- é€±æœ«èƒŒæ™¯æ’ä»¶ (åƒ…æ¨™ç¤ºé€±å…­æ—¥) ---
    const weekendPlugin = {
        id: 'weekendPlugin',
        beforeDraw: (chart) => {
            const { ctx, chartArea: { top, bottom, height }, scales: { x } } = chart;
            ctx.save();

            x.ticks.forEach((tick, index) => {
                const dateStr = chart.data.rawDates[index]; // å–å¾—åŸå§‹æ—¥æœŸ YYYY-MM-DD
                if (!dateStr) return;

                const dateObj = new Date(dateStr);
                const dayOfWeek = dateObj.getDay(); // 0=é€±æ—¥, 6=é€±å…­

                // åˆ¤æ–·æ˜¯å¦ç‚ºé€±æœ«
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);

                if (isWeekend) {
                    const width = x.width / x.ticks.length;
                    const xPos = x.getPixelForTick(index) - (width / 2);

                    // --- èƒŒæ™¯é¡è‰²: 10% é»‘è‰² ---
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; 
                    ctx.fillRect(xPos, top, width, height);

                    // --- æ¨™ç¤ºæ–‡å­— ---
                    ctx.fillStyle = '#333'; 
                    ctx.font = 'bold 12px "Microsoft JhengHei"';
                    ctx.textAlign = 'center';
                    
                    let text = "";
                    if (dayOfWeek === 6) text = "é€±å…­";
                    else if (dayOfWeek === 0) text = "é€±æ—¥";

                    ctx.fillText(text, x.getPixelForTick(index), top + 15);
                }
            });
            ctx.restore();
        }
    };

    function getWeatherEmoji(code) {
        if (code === 0) return 'â˜€ï¸'; 
        if (code <= 3) return 'â˜ï¸'; 
        if (code <= 48) return 'ğŸŒ«ï¸'; 
        if (code <= 67) return 'ğŸŒ§ï¸'; 
        if (code <= 77) return 'â„ï¸'; 
        if (code <= 82) return 'ğŸŒ§ï¸'; 
        if (code <= 86) return 'ğŸŒ¨ï¸'; 
        if (code <= 99) return 'â›ˆï¸'; 
        return '';
    }

    async function analyzeWeather() {
        const threshold = parseFloat(document.getElementById('dropThreshold').value);
        const windowDays = parseInt(document.getElementById('windowDays').value);
        const lagMin = parseInt(document.getElementById('lagMin').value);
        const lagMax = parseInt(document.getElementById('lagMax').value);
        
        document.getElementById('loading').style.display = 'block';
        document.getElementById('statusBox').style.display = 'none';
        document.getElementById('logContent').innerHTML = '';
        
        try {
            const promises = cities.map(city => {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&daily=temperature_2m_min,weathercode&timezone=auto&forecast_days=16`;
                return fetch(url).then(res => res.json());
            });

            const results = await Promise.all(promises);
            document.getElementById('loading').style.display = 'none';

            const weatherData = {};
            const weatherCodes = {};
            
            const rawDates = results[0].daily.time; 
            const displayLabels = rawDates.map(date => date.substring(5).replace('-', '/'));

            results.forEach((data, index) => {
                const cityId = cities[index].id;
                weatherData[cityId] = data.daily.temperature_2m_min;
                weatherCodes[cityId] = data.daily.weathercode;
            });

            drawChart(displayLabels, rawDates, weatherData, weatherCodes);

            let alerts = [];
            const dataA = weatherData['A'];
            const dataB = weatherData['B'];
            const dataC = weatherData['C'];
            
            const maxScanDay = dataA.length - windowDays - (lagMax * 2);

            for (let i = 0; i < dataA.length - windowDays; i++) {
                let dropA = dataA[i] - dataA[i + windowDays];

                if (dropA >= threshold) {
                    let dateStartA = displayLabels[i];
                    
                    for (let d1 = lagMin; d1 <= lagMax; d1++) {
                        let idxB = i + d1;
                        if (idxB + windowDays >= dataB.length) continue;
                        
                        let dropB = dataB[idxB] - dataB[idxB + windowDays];

                        if (dropB >= threshold) {
                            let dateStartB = displayLabels[idxB];
                            
                            for (let d2 = lagMin; d2 <= lagMax; d2++) {
                                let idxC = idxB + d2;
                                if (idxC + windowDays >= dataC.length) continue;

                                let dropC = dataC[idxC] - dataC[idxC + windowDays];

                                if (dropC >= threshold) {
                                    let dateStartC = displayLabels[idxC];
                                    let dateEndC = displayLabels[idxC + windowDays];
                                    
                                    let alertId = `${dateStartA}-${dateStartB}-${dateStartC}`;
                                    
                                    if (!alerts.some(a => a.id === alertId)) {
                                        alerts.push({ 
                                            id: alertId,
                                            msg: `
                                            <div style="font-weight:bold; color:#333; margin-bottom:4px;">â„ï¸ è·¯å¾‘ç¢ºèª (${windowDays}å¤©è·Œ${threshold}åº¦)</div>
                                            <span style="color:${cities[0].color}">â—</span> é›…åº«æ¬¡å…‹ (${dateStartA}): é™ <b>${dropA.toFixed(1)}Â°C</b><br>
                                            <span style="color:${cities[1].color}">â—</span> åŒ—äº¬ (${dateStartB}): é™ <b>${dropB.toFixed(1)}Â°C</b> (è·A ${d1}å¤©)<br>
                                            <span style="color:${cities[2].color}">â—</span> ä¸Šæµ· (${dateStartC}): é™ <b>${dropC.toFixed(1)}Â°C</b> (è·B ${d2}å¤©)<br>
                                            ğŸ‘‰ <b>å°åŒ—è«‹åœ¨ ${dateEndC} å¾Œæˆ’å‚™ï¼</b>
                                            ` 
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
            }

            const statusBox = document.getElementById('statusBox');
            if (alerts.length > 0) {
                statusBox.className = 'alert-box alert-danger';
                statusBox.innerHTML = `âš ï¸ <b>è­¦å ±ï¼</b> åµæ¸¬åˆ° ${alerts.length} æ¢å¯’æµè·¯å¾‘ (æ¢ä»¶: ${windowDays}å¤©å…§ç´¯ç©é™æº« > ${threshold}Â°C)ã€‚`;
                statusBox.style.display = 'block';
                alerts.forEach(a => {
                    const d = document.createElement('div');
                    d.className = 'log-item';
                    d.innerHTML = a.msg;
                    document.getElementById('logContent').appendChild(d);
                });
            } else {
                statusBox.className = 'alert-box alert-success';
                statusBox.innerHTML = `âœ… æœªä¾† 16 å¤©å…§ï¼Œæœªåµæ¸¬åˆ°ã€Œé€£çºŒ ${windowDays} å¤©ç´¯ç©é™æº«è¶…é ${threshold}Â°Cã€çš„é€£é–å¯’æµã€‚`;
                statusBox.style.display = 'block';
            }

        } catch (error) {
            console.error(error);
            document.getElementById('loading').style.display = 'none';
        }
    }

    function drawChart(labels, rawDates, tempMap, codeMap) {
        const ctx = document.getElementById('weatherChart').getContext('2d');
        if (myChart) myChart.destroy();

        const datasets = cities.map((city) => ({
            label: city.name,
            data: tempMap[city.id],
            borderColor: city.color,
            backgroundColor: city.color,
            borderWidth: 2,
            pointRadius: 4,
            yAxisID: city.axis,
            datalabels: {
                align: 'top',
                anchor: 'center',
                offset: 4,
                color: '#333',
                font: { size: 15, weight: 'bold', family: 'Segoe UI Emoji' }, 
                formatter: (value, ctx) => {
                    const code = codeMap[city.id][ctx.dataIndex];
                    return Math.round(value) + 'Â°\n' + getWeatherEmoji(code);
                },
                textAlign: 'center'
            }
        }));

        myChart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: labels, 
                datasets: datasets,
                rawDates: rawDates 
            },
            plugins: [weekendPlugin], 
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 30, bottom: 10 } },
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { grid: { drawOnChartArea: false } }, 
                    yA: { type: 'linear', position: 'left', stack: 'weatherStack', stackWeight: 1, title: { display: true, text: 'A-é›…åº«æ¬¡å…‹', color: '#1976D2' }, grid: { color: '#eee' } },
                    yB: { type: 'linear', position: 'left', stack: 'weatherStack', stackWeight: 1, title: { display: true, text: 'B-åŒ—äº¬', color: '#F57C00' }, grid: { color: '#eee' }, offset: true },
                    yC: { type: 'linear', position: 'left', stack: 'weatherStack', stackWeight: 1, title: { display: true, text: 'C-ä¸Šæµ·', color: '#388E3C' }, grid: { color: '#eee' }, offset: true },
                    yD: { type: 'linear', position: 'left', stack: 'weatherStack', stackWeight: 1, title: { display: true, text: 'D-å°åŒ—', color: '#D32F2F' }, grid: { color: '#eee' }, offset: true }
                },
                plugins: { legend: { display: false }, tooltip: { enabled: true } }
            }
        });
    }
</script>

</body>
</html>