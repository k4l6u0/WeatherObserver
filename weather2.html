<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯’æµé è­¦ç³»çµ± - A, B, C, DåŸå¸‚é€£å‹•</title>
    
    <script src="https://unpkg.com/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://unpkg.com/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        /* æ·ºè‰²èƒŒæ™¯è¨­å®š */
        :root {
            --bg-color: #f4f7f9;
            --container-bg: #fff;
            --text-color: #2c3e50;
            --primary-color: #3498db;
            --secondary-bg: #ecf0f1;
        }

        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            margin: 0; padding: 20px; 
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
        .container { 
            max-width: 1200px; margin: auto; padding: 25px; 
            background-color: var(--container-bg); 
            border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        h1 { color: #2c3e50; text-align: center; }
        hr { border-top: 1px solid #bdc3c7; }
        
        /* è­¦ç¤ºæ¡†æ¨£å¼ */
        .alert-box { 
            padding: 15px; margin-bottom: 20px; border-radius: 6px; 
            font-size: 1.2em; font-weight: bold; text-align: center; 
        }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* ç´°ç¯€åˆ—è¡¨æ¨£å¼ */
        #eventDetails ul { list-style-type: none; padding: 0; }
        #eventDetails li { 
            background-color: #ecf0f1; 
            padding: 15px; margin-bottom: 10px; border-radius: 6px; 
            border-left: 5px solid #e74c3c; 
        }
        #eventDetails li strong { color: #c0392b; }
        #eventDetails li em { color: #7f8c8d; }
        
        /* åœ–è¡¨å®¹å™¨ */
        .chart-container { margin-bottom: 30px; }

        /* åº•éƒ¨è³‡è¨Š */
        #updateTime { color: var(--primary-color); }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¥¶ æ±äºå¯’æµé€£é–é è­¦ç³»çµ± (ç´”å‰ç«¯)</h1>
    <p style="text-align: center;">æ•¸æ“šä¾†æºï¼šOpen-Meteo (æœªä¾† 16 å¤©æœ€ä½æº«é å ±)</p>
    <hr>
    
    <div id="alertStatus" class="alert-box alert-success">
        æ­£åœ¨è¼‰å…¥æ•¸æ“šä¸¦é€²è¡Œåˆ¤æ–·...
    </div>

    <div class="chart-container">
        <canvas id="tempChart"></canvas>
    </div>

    <h2>é€£é–é™æº«äº‹ä»¶è©³æƒ…</h2>
    <div id="eventDetails">
        </div>

    <p style="text-align: right; font-size: 0.8em; color: #7f8c8d;">æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š<span id="updateTime"></span></p>
</div>

<script>
// è¨»å†Š Chart.js æ’ä»¶ (ç‚ºäº†é¡¯ç¤ºæ•¸å€¼)
Chart.register(ChartDataLabels);

// --- æ ¸å¿ƒé…ç½® ---
const CITIES = {
    A: { name: 'Yakutsk(é›…åº«èŒ¨å…‹)', lat: 62.03, lon: 129.73, color: 'rgb(54, 162, 235)' },
    B: { name: 'Beijing(åŒ—äº¬)', lat: 39.90, lon: 116.40, color: 'rgb(255, 99, 132)' },
    C: { name: 'Shanghai(ä¸Šæµ·)', lat: 31.23, lon: 121.47, color: 'rgb(75, 192, 192)' },
	D: { name: 'Taipei(å°åŒ—)', lat: 25.03, lon: 121.52, color: 'rgb(192, 192, 192)' }
};

// --- å¯’æµåˆ¤æ–·åƒæ•¸ï¼ˆå¯èª¿æ•´ï¼‰---
const DROP_THRESHOLD = 5;      // é™æº«å¹…åº¦ (åº¦C)
const DAYS_DELAY_MIN = 1;      // æœ€å°å»¶é²å¤©æ•¸
const DAYS_DELAY_MAX = 3;      // æœ€å¤§å»¶é²å¤©æ•¸
const FORECAST_DAYS = 16;      // é å ±å¤©æ•¸

// --- å‡½æ•¸å€ ---

/**
 * é€é Open-Meteo API ç²å–æŒ‡å®šç¶“ç·¯åº¦æœªä¾† 10 å¤©çš„æ°£æº«æ•¸æ“šã€‚
 */
async function fetchWeatherData(lat, lon) {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_min&forecast_days=${FORECAST_DAYS}&timezone=Asia%2FShanghai`;
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`Failed to fetch data for ${lat}, ${lon}: ${response.statusText}`);
    }
    return response.json();
}

/**
 * æª¢æŸ¥å–®ä¸€åŸå¸‚æ˜¯å¦åœ¨æŒ‡å®šæ—¥æœŸ i ç™¼ç”Ÿé™æº«äº‹ä»¶ã€‚
 */
function isDrop(temps, i, threshold) {
    return temps[i] !== undefined && temps[i+1] !== undefined && (temps[i] - temps[i+1] >= threshold);
}

/**
 * ç¹ªè£½æ°£æº«æŠ˜ç·šåœ– (æ›´æ–° Chart.js é¸é …ä»¥é¡¯ç¤ºæ•¸å€¼)
 */
function renderChart(dates, datasets) {
    const ctx = document.getElementById('tempChart').getContext('2d');

    Chart.defaults.color = '#2c3e50';

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'æœªä¾† 10 å¤©æœ€ä½æ°£æº«è¶¨å‹¢ (åº¦C)', font: { size: 18 } },
                legend: { position: 'bottom' },
                // è¨­å®š Data Labels æ’ä»¶ä»¥é¡¯ç¤ºæ•¸å€¼
                datalabels: {
                    align: 'top', 
                    color: '#2c3e50', 
                    formatter: function(value) {
                        return `${value.toFixed(0)}Â°C`; 
                    },
                    font: { size: 10, weight: 'bold' }
                }
            },
            scales: {
                x: {
                    grid: { color: '#bdc3c7' } 
                },
                y: { 
                    beginAtZero: false, 
                    title: { display: true, text: 'æº«åº¦ (Â°C)' },
                    grid: { color: '#bdc3c7' } 
                }
            }
        }
    });
}

/**
 * æ ¸å¿ƒåˆ¤æ–·é‚è¼¯ï¼šæª¢æŸ¥ A -> B -> C é€£é–é™æº«
 */
function checkColdWave(data) {
    const tempsA = data.A.daily.temperature_2m_min;
    const tempsB = data.B.daily.temperature_2m_min;
    const tempsC = data.C.daily.temperature_2m_min;
	const tempsD = data.D.daily.temperature_2m_min;
    
    let isWarning = false;
    let detailsHTML = '<ul>';

    // å¾ç¬¬ 0 å¤©é–‹å§‹æª¢æŸ¥ A åŸå¸‚çš„é™æº«
    for (let i = 0; i < FORECAST_DAYS - DAYS_DELAY_MAX * 2 - 1; i++) { 
        if (isDrop(tempsA, i, DROP_THRESHOLD)) {
            const dateA = data.A.daily.time[i+1];
            const dropA = tempsA[i] - tempsA[i+1];

            // æª¢æŸ¥ B åŸå¸‚é™æº« (åœ¨ A é™æº«å¾Œ [MIN, MAX] å¤©å…§)
            for (let j = i + DAYS_DELAY_MIN; j <= i + DAYS_DELAY_MAX && j < FORECAST_DAYS - 1; j++) {
                if (isDrop(tempsB, j, DROP_THRESHOLD)) {
                    const dateB = data.B.daily.time[j+1];
                    const dropB = tempsB[j] - tempsB[j+1];

                    // æª¢æŸ¥ C åŸå¸‚é™æº« (åœ¨ B é™æº«å¾Œ [MIN, MAX] å¤©å…§)
                    for (let k = j + DAYS_DELAY_MIN; k <= j + DAYS_DELAY_MAX && k < FORECAST_DAYS - 1; k++) {
                        if (isDrop(tempsC, k, DROP_THRESHOLD)) {
                            isWarning = true;
                            const dateC = data.C.daily.time[k+1];
                            const dropC = tempsC[k] - tempsC[k+1];
								
                            // ç´€éŒ„é€£é–äº‹ä»¶
                            detailsHTML += `
                                <li>
                                    <strong>ğŸš¨ æ½›åœ¨å¯’æµé è­¦è§¸ç™¼ï¼</strong><br>
                                    - A (${CITIES.A.name}): ${dateA} é™æº« ${dropA.toFixed(1)}Â°C (å¾ ${tempsA[i].toFixed(1)}Â°C é™è‡³ ${tempsA[i+1].toFixed(1)}Â°C)<br>
                                    - B (${CITIES.B.name}): ${dateB} é™æº« ${dropB.toFixed(1)}Â°C (å»¶é² ${j - i} å¤©) (å¾ ${tempsB[j].toFixed(1)}Â°C é™è‡³ ${tempsB[j+1].toFixed(1)}Â°C)<br>
                                    - C (${CITIES.C.name}): ${dateC} é™æº« ${dropC.toFixed(1)}Â°C (å»¶é² ${k - j} å¤©) (å¾ ${tempsC[k].toFixed(1)}Â°C é™è‡³ ${tempsC[k+1].toFixed(1)}Â°C)<br>
                                    - D (${CITIES.D.name}): ${dateC} é™æº« ${dropC.toFixed(1)}Â°C (å»¶é² ${k - j} å¤©) (å¾ ${tempsD[k].toFixed(1)}Â°C é™è‡³ ${tempsD[k+1].toFixed(1)}Â°C)<br>
                                    <small><em>é è¨ˆå°åŒ—åœ¨ C é™æº«å¾Œ 1-3 å¤©å¯èƒ½å—å½±éŸ¿ã€‚</em></small>
                                </li>
                            `;
                        }
                    }
                }
            }
        }
    }

    detailsHTML += '</ul>';
    
    const alertBox = document.getElementById('alertStatus');
    const detailsBox = document.getElementById('eventDetails');

    if (isWarning) {
        alertBox.className = 'alert-box alert-warning';
        alertBox.innerHTML = 'ğŸš¨ **å¼·çƒˆè­¦å‘Šï¼šé æ¸¬åˆ° A â†’ B â†’ C é€£é–é™æº«æ¨¡å¼ï¼** è«‹ç•™æ„å°åŒ—åœ°å€çš„å¯’æµé å ±ã€‚';
        detailsBox.innerHTML = detailsHTML;
    } else {
        alertBox.className = 'alert-box alert-success';
        alertBox.innerHTML = 'âœ… **ç›®å‰ç„¡ A â†’ B â†’ C é€£é–é™æº«æ¨¡å¼è·¡è±¡ã€‚**';
        detailsBox.innerHTML = '<p style="text-align: center;">åœ¨æœªä¾† 10 å¤©é å ±ä¸­ï¼Œæœªç™¼ç¾ç¬¦åˆé€£é–é™æº«æ¢ä»¶çš„äº‹ä»¶ã€‚</p>';
    }
}

/**
 * ä¸»åŸ·è¡Œå‡½æ•¸ (å·²ä¿®å¾©æˆªæ–·éƒ¨åˆ†)
 */
async function main() {
    try {
        const promises = Object.keys(CITIES).map(key => 
            fetchWeatherData(CITIES[key].lat, CITIES[key].lon)
                .then(data => ({ key, data }))
        );
        
        const results = await Promise.all(promises);
        
        const allData = {};
        // å°‡æ—¥æœŸæ ¼å¼åŒ–ç‚ºæœˆ/æ—¥ (ä¾‹å¦‚ 11/17)
        const dates = results[0].data.daily.time.map(d => 
            new Date(d).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' })
        );
        const datasets = [];

        results.forEach(res => {
            allData[res.key] = res.data;
            datasets.push({
                label: CITIES[res.key].name,
                data: res.data.daily.temperature_2m_min,
                borderColor: CITIES[res.key].color,
                backgroundColor: CITIES[res.key].color + '60', 
                tension: 0.1,
                fill: false, 
                pointRadius: 5,
                pointHoverRadius: 8
            });
        });

        // ç¹ªè£½åœ–è¡¨
        renderChart(dates, datasets);

        // åŸ·è¡Œå¯’æµåˆ¤æ–·é‚è¼¯
        checkColdWave(allData);

        document.getElementById('updateTime').innerText = new Date().toLocaleString('zh-TW');

    } catch (error) {
        console.error("åŸ·è¡ŒéŒ¯èª¤:", error);
        // ç•¶æ•¸æ“šè¼‰å…¥å¤±æ•—æ™‚ï¼Œé¡¯ç¤ºè©³ç´°éŒ¯èª¤è¨Šæ¯
        document.getElementById('alertStatus').className = 'alert-box alert-warning';
        document.getElementById('alertStatus').innerHTML = `âš ï¸ <strong>æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼</strong> éŒ¯èª¤è¨Šæ¯ï¼š${error.message}ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚`;
    }
}

// å•Ÿå‹•ä¸»ç¨‹å¼
main();
</script>

</body>
</html>